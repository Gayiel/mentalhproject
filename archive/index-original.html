<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Mind Flow — MoodHouse</title>
        <link rel="stylesheet" href="style.css" />
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
        <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,0..200" />
        <style>
            :root {
                /* Base Theme Colors */
                --primary-50: #f0f7ff;
                --primary-100: #e0f2fe;
                --primary-200: #bae6fd;
                --primary-300: #7dd3fc;
                --primary-400: #38bdf8;
                --primary-500: #0ea5e9;
                --primary-600: #0284c7;
                
                --neutral-50: #f8fafc;
                --neutral-100: #f1f5f9;
                --neutral-200: #e2e8f0;
                --neutral-300: #cbd5e1;
                --neutral-400: #94a3b8;
                --neutral-500: #64748b;
                --neutral-600: #475569;
                --neutral-700: #334155;
                --neutral-800: #1e293b;
                --neutral-900: #0f172a;
                
                /* Semantic Colors */
                --success: #4ade80;
                --warning: #fbbf24;
                --danger: #f87171;
                --info: #60a5fa;
                
                /* UI Elements */
                --bg-primary: var(--neutral-50);
                --bg-secondary: white;
                --bg-tertiary: var(--primary-50);
                
                --text-primary: var(--neutral-900);
                --text-secondary: var(--neutral-700);
                --text-tertiary: var(--neutral-500);
                
                --border-light: var(--neutral-200);
                --border-medium: var(--neutral-300);
                
                /* Component Specific */
                --chat-user-bg: linear-gradient(135deg, var(--primary-100), var(--primary-200));
                --chat-bot-bg: linear-gradient(135deg, var(--neutral-100), var(--neutral-200));
                
                /* Animation Speeds */
                --transition-fast: 150ms;
                --transition-normal: 250ms;
                --transition-slow: 350ms;
                
                /* Spacing */
                --space-xs: 0.25rem;
                --space-sm: 0.5rem;
                --space-md: 1rem;
                --space-lg: 1.5rem;
                --space-xl: 2rem;
                
                /* Shadows */
                --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
                --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
                --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
                
                /* Rounded Corners */
                --radius-sm: 0.25rem;
                --radius-md: 0.5rem;
                --radius-lg: 0.75rem;
                --radius-xl: 1rem;
                --radius-full: 9999px;
            }
            
            [data-theme="dark"] {
                --bg-primary: var(--neutral-900);
                --bg-secondary: var(--neutral-800);
                --bg-tertiary: var(--neutral-700);
                
                --text-primary: var(--neutral-100);
                --text-secondary: var(--neutral-300);
                --text-tertiary: var(--neutral-400);
                
                --border-light: var(--neutral-700);
                --border-medium: var(--neutral-600);
                
                --chat-user-bg: linear-gradient(135deg, #0c4a6e, #0369a1);
                --chat-bot-bg: linear-gradient(135deg, #1e293b, #334155);
            }
        </style>
    <script>window.MF_PUBLIC_FEED = true; /* feature flag: public read-only feed */</script>
    <script defer src="public-feed.js"></script>
    <script defer src="sentimentAdapter.js"></script>
    <script defer src="riskClassifier.js"></script>
    <script defer src="conversationCore-enhanced.js"></script>
    <script defer src="testHarness.js"></script>
    </head>
    <body>
    <button id="panic-return" class="control-btn" title="Return to Mind Flow view" style="font-size:11px;">Return</button>
    <div id="legacy-app" data-legacy>
        <a class="skip-link" href="#mind-flow-root">Skip to main content</a>

        <header class="topbar" role="banner" aria-label="Top navigation">
            <div class="topbar-left">
                <div class="avatar" aria-hidden="true">MH</div>
                <div class="brand">
                    <strong class="brand-title">MoodHouse</strong>
                    <span class="brand-sub">Daily Check-in</span>
                </div>
            </div>
            <nav class="top-actions" aria-label="Profile actions">
                <button id="toggle-soft-btn" class="control-btn" aria-pressed="false" title="Toggle softer colors">Softer colors</button>
                <button class="icon-btn" aria-label="Settings">⚙️</button>
            </nav>
        </header>

        <div class="site-hero">
            <h1>Mind Flow</h1>
            <p>A private, accessible place to track how you feel and find guidance when needed.</p>
        </div>

        <main id="mood-app-container">

            <!-- Mind Flow replaces the old 'How are you feeling today?' logger -->
            <section id="mind-flow" aria-labelledby="mind-flow-title" class="card">
                <h2 id="mind-flow-title">Mind Flow</h2>
                <div id="mind-flow-root"></div>
            </section>

                <!-- Minimal hidden legacy logger (kept for script.js compatibility) -->
                <section id="mood-logger" class="sr-only" aria-hidden="true">
                    <h2 id="logger-title" class="sr-only">How are you feeling today?</h2>
                    <form id="mood-log-form">
                        <p class="date-display">Today's Date: <time id="current-date" datetime=""></time></p>
                        <fieldset class="mood-scale" role="radiogroup" aria-label="Select your current mood">
                            <legend class="sr-only">Mood Selection</legend>
                            <!-- single radio so legacy scripts and self-test can tick a value -->
                            <input type="radio" id="mood-vgood" name="mood" value="5">
                            <label for="mood-vgood">Very Good</label>
                        </fieldset>

                        <div class="input-group">
                            <label for="activity-tags" class="sr-only">Activity tags</label>
                            <input type="text" id="activity-tags" placeholder="Tags (comma separated)" />
                        </div>

                        <div class="input-group">
                            <label for="mood-notes" class="sr-only">Notes</label>
                            <textarea id="mood-notes" rows="2"></textarea>
                        </div>

                        <button type="submit" id="log-mood-btn">Log My Mood</button>
                    </form>
                </section>

            <aside id="resource-banner" class="alert-banner hidden" role="alert" aria-live="polite">
                <p>It looks like you've logged a challenging mood pattern. <strong>Immediate, affordable support is available.</strong></p>
                <a href="resources.html" class="secondary-btn">Access Guided Resources</a>
            </aside>

            <section id="mood-history" aria-labelledby="history-title" class="card">
                <div class="history-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                    <h2 id="history-title" style="margin:0">Your Mood Trends</h2>
                    <div>
                        <button id="toggle-history-btn" class="control-btn" aria-expanded="true" aria-controls="mood-chart-container log-list">Collapse</button>
                    </div>
                </div>

                <div class="filter-controls">
                    <button id="view-7-day" class="control-btn active" aria-controls="mood-chart">7-Day Trend</button>
                    <button id="view-30-day" class="control-btn" aria-controls="mood-chart">Monthly Summary</button>
                    <button id="find-support-btn" class="control-btn" type="button">Find Nearby Support</button>
                </div>

                <div id="mood-chart-container" class="chart-container">
                    <canvas id="mood-chart" role="img" aria-label="Interactive line graph displaying your daily average mood score." aria-describedby="chart-desc"></canvas>
                    <p id="chart-desc" class="sr-only">This chart shows the recent trend of your daily mood scores. Higher values represent better mood.</p>
                    <div id="no-data" class="no-data" aria-hidden="true">No mood logs yet. Your entries will appear here.</div>
                </div>

                <div id="log-list" class="card" aria-live="polite">
                    <h3>Your Logs</h3>
                    <div id="logs-container">
                        <p class="text-muted">No logs yet. Your entries will appear here.</p>
                    </div>
                </div>
            </section>

            <section id="therapists" aria-labelledby="therapists-title" class="card">
                <h2 id="therapists-title" style="margin-top:0">Available Therapists</h2>
                <p class="text-muted" style="margin-top:4px; font-size:0.9rem">Browse supportive professionals (sample/demo data). Filter by specialty or modality.</p>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:12px 0 6px;">
                    <input id="therapist-filter" type="search" placeholder="Filter (e.g. anxiety, cbt)" aria-label="Filter therapists" style="flex:1; padding:8px 10px; border-radius:8px; border:1px solid var(--glass-border);" />
                    <button type="button" id="therapist-clear" class="control-btn">Clear</button>
                </div>
                <div id="therapist-list" class="therapist-list" aria-live="polite"></div>
                <div id="therapist-loading" class="therapist-list" aria-hidden="true" style="display:none;">
                    <div class="therapist-card therapist-skeleton"><div class="sk-lines"><div class="sk-line w60"></div><div class="sk-line w40"></div><div class="sk-line w80"></div></div></div>
                    <div class="therapist-card therapist-skeleton"><div class="sk-lines"><div class="sk-line w80"></div><div class="sk-line w60"></div><div class="sk-line w40"></div></div></div>
                    <div class="therapist-card therapist-skeleton"><div class="sk-lines"><div class="sk-line w60"></div><div class="sk-line w40"></div><div class="sk-line w80"></div></div></div>
                </div>
            </section>

        </main>

        <footer class="page-footer" role="contentinfo">
            <p>Private &middot; For self-reflection and to help connect to resources when needed.</p>
        </footer>

        <div id="toast-area" aria-live="polite" aria-atomic="true"></div>
        <div id="consent-banner" class="consent-banner hidden" role="dialog" aria-modal="true" aria-labelledby="consent-title">
            <div class="cb-inner">
                <h3 id="consent-title" style="margin:0 0 6px; font-size:1rem;">Session & Privacy</h3>
                <p style="margin:0 0 10px; font-size:0.8rem; line-height:1.3">Mind Flow is a supportive assistant, not a clinical tool. Messages stay in your browser unless you opt-in to external analysis for improved emotional detection.</p>
                <form id="consent-form" style="display:flex; flex-direction:column; gap:8px;">
                    <label style="display:flex; gap:6px; align-items:flex-start; font-size:0.78rem;">
                        <input type="checkbox" id="consent-nlp" />
                        <span>Allow external sentiment analysis API (may send anonymized text).</span>
                    </label>
                    <label style="display:flex; gap:6px; align-items:flex-start; font-size:0.78rem;">
                        <input type="checkbox" id="consent-retain" />
                        <span>Retain session transcript locally for next visit.</span>
                    </label>
                    <label style="display:flex; gap:6px; align-items:flex-start; font-size:0.78rem;">
                        <input type="checkbox" id="consent-analytics" />
                        <span>Anonymous usage analytics (improve supportive responses).</span>
                    </label>
                    <div style="display:flex; gap:8px; margin-top:6px;">
                        <button type="submit" class="primary-btn" style="padding:8px 14px; font-size:0.75rem;">Accept & Continue</button>
                        <button type="button" id="consent-decline" class="control-btn" style="padding:8px 14px; font-size:0.75rem;">Decline</button>
                    </div>
                </form>
            </div>
        </div>

        <script src="script.js"></script>
                                <script>
                // Hide chart area until at least one log exists
                (function(){
                    function toggleChartVisibility(){
                        try{
                            const raw = localStorage.getItem('accessibleMoodHistory');
                            const arr = raw? JSON.parse(raw): [];
                            const container = document.getElementById('mood-chart-container');
                            if(!container) return;
                                            if(!arr.length){
                                                container.classList.add('chart-hidden');
                                            } else {
                                                // trigger animated reveal only once
                                                if(container.classList.contains('chart-hidden')){
                                                    requestAnimationFrame(()=>{
                                                        container.classList.remove('chart-hidden');
                                                        container.classList.add('chart-revealed');
                                                    });
                                                }
                                            }
                        }catch(e){}
                    }
                    window.addEventListener('moodHistoryUpdated', toggleChartVisibility);
                    window.addEventListener('DOMContentLoaded', toggleChartVisibility);
                })();

                                // Therapist directory fetch with localStorage cache + API fallback (enhanced logging)
                                (function(){
                                    const LS_KEY='therapistDirectoryCacheV1';
                                    let data=[];
                                    let apiTried=false;
                                    let initialRendered=false;
                                    function render(list){
                                        const host=document.getElementById('therapist-list'); if(!host) return;
                                        host.innerHTML='';
                                        if(!list.length){ host.innerHTML='<p class="text-muted">No matches.</p>'; return; }
                                        list.forEach(t=>{
                                            const card=document.createElement('div'); card.className='therapist-card';
                                            card.innerHTML=`<div class='t-head'><strong>${t.name}</strong> <span class='t-mod'>${t.modality}</span></div>
                                                <div class='t-focus'>${(t.focus||[]).map(f=>`<span>#${f}</span>`).join(' ')}</div>
                                                <div class='t-meta'><span>${t.slots||'Schedule TBD'}</span> · <span>${t.remote?'Remote / In-person':'In-person only'}</span></div>
                                                <button class='primary-btn t-contact' type='button'>Contact</button>`;
                                            card.querySelector('.t-contact').addEventListener('click',()=>{ alert('Contact flow demo: '+t.name); });
                                            host.appendChild(card);
                                        });
                                    }
                                    function filter(){
                                        const q=(document.getElementById('therapist-filter')?.value||'').trim().toLowerCase();
                                        if(!q) return render(data);
                                        const parts=q.split(/\s+/).filter(Boolean);
                                        render(data.filter(t => parts.every(p => t.name.toLowerCase().includes(p) || (t.focus||[]).some(f=>f.includes(p)) || (t.modality||'').toLowerCase().includes(p))));
                                    }
                                    function showLoading(on){ const sk=document.getElementById('therapist-loading'); if(sk){ sk.style.display=on?'grid':'none'; sk.setAttribute('aria-hidden', on?'false':'true'); } }
                                    function showError(msg){ const host=document.getElementById('therapist-list'); if(host && !initialRendered){ host.innerHTML = '<p class="text-muted">'+msg+'</p>'; } }
                                    async function load(){
                                        const cached=localStorage.getItem(LS_KEY);
                                        if(cached){ try { data=JSON.parse(cached); } catch(e){} }
                                        if(data.length){ render(data); initialRendered=true; }
                                        showLoading(true);
                                        try {
                                            // First attempt API endpoint
                                            if(!apiTried){
                                                apiTried=true;
                                                try {
                                                    const apiRes=await fetch('/api/therapists',{headers:{'Accept':'application/json'}});
                                                    if(apiRes.ok){ const apiData=await apiRes.json(); if(Array.isArray(apiData) && apiData.length){ data=apiData; localStorage.setItem(LS_KEY, JSON.stringify(apiData)); filter(); initialRendered=true; showLoading(false); return; } else { console.warn('[therapists] API returned no array'); } }
                                                    else { console.warn('[therapists] API status', apiRes.status); }
                                                } catch(e){ console.error('[therapists] API fetch error', e); }
                                            }
                                            const res=await fetch('therapists.json',{cache:'no-cache'});
                                            if(res.ok){ const fresh= await res.json(); if(Array.isArray(fresh) && fresh.length){ data=fresh; localStorage.setItem(LS_KEY, JSON.stringify(fresh)); filter(); initialRendered=true; } else { console.warn('[therapists] local file empty or invalid'); } }
                                            else { console.warn('[therapists] local file status', res.status); }
                                        } catch(e){ console.error('[therapists] local file fetch error', e); }
                                        if(!data.length){ showError('Directory temporarily unavailable. Please retry later.'); }
                                        showLoading(false);
                                    }
                                    window.addEventListener('DOMContentLoaded',()=>{
                                        load();
                                        const inp=document.getElementById('therapist-filter'); if(inp) inp.addEventListener('input', filter);
                                        const clr=document.getElementById('therapist-clear'); if(clr) clr.addEventListener('click', ()=>{ if(inp){ inp.value=''; filter(); } });
                                    });
                                })();
                </script>

        <!-- Mind Flow React component (Babel) -->
        <script type="text/babel">
        // Mind Flow component — single copy
        const STORAGE_KEY = 'accessibleMoodHistory';
        function safeParse(json){ try { return JSON.parse(json) } catch(e) { return null } }
        function nowDate(){ return new Date().toISOString().slice(0,10) }

        function MindFlow(){
            const [logs, setLogs] = React.useState(() => safeParse(localStorage.getItem(STORAGE_KEY)) || [])
            const [input, setInput] = React.useState('')
            const [messages, setMessages] = React.useState([])
            const [isTyping, setIsTyping] = React.useState(false)
            const [currentStarter, setCurrentStarter] = React.useState(null)
            const scrollRef = React.useRef(null)
            const lastStarterRef = React.useRef(null)
            // Removed mood & tag editing UI for a calmer minimal chat surface
            const [lastInsightSig, setLastInsightSig] = React.useState(null)
            const [insightsEnabled, setInsightsEnabled] = React.useState(() => localStorage.getItem('mf_insights_enabled') !== 'false')
            const [riskMeta, setRiskMeta] = React.useState({ level:'normal', score:0 })
            const [consent, setConsent] = React.useState({ nlp:false, retain:false, ready:false })
            const sessionIdRef = React.useRef(localStorage.getItem('mf_session_id') || (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)))
            React.useEffect(()=>{ localStorage.setItem('mf_session_id', sessionIdRef.current) }, [])
            const [sessionPhase, setSessionPhase] = React.useState('init') // init | active | ending | ended
            const [actions, setActions] = React.useState([]) // [{label, handler}]
            const [lastSuggestion, setLastSuggestion] = React.useState(null)
            const [escalation, setEscalation] = React.useState({ offered:false, accepted:false })
            const greetedRef = React.useRef(false)
            const firstUserMessageRef = React.useRef(null)

            // startOptions provided later by core module (removed local array)

            function persistLogs(next){
                localStorage.setItem(STORAGE_KEY, JSON.stringify(next))
                setLogs(next)
                try{ if (typeof renderMoodChart === 'function') renderMoodChart(next) } catch(e){}
                try{ if (typeof renderLogsList === 'function') renderLogsList(next) } catch(e){}
                try{ window.dispatchEvent(new CustomEvent('moodHistoryUpdated',{detail: next})) } catch(e){}
                try{ if (typeof showToast === 'function') showToast('Saved to Your Logs') } catch(e){}
            }

            React.useEffect(()=>{
                // Initial lightweight greeting (remember only once per session render)
                if(!greetedRef.current){
                    pushBot("Hi — I'm Mind Flow, an AI support assistant (not a clinician). I'll wait for you to review privacy before we begin.")
                    greetedRef.current = true
                }
                try{ if (typeof renderMoodChart === 'function') renderMoodChart(logs) } catch(e){}
                try{ if (typeof renderLogsList === 'function') renderLogsList(logs) } catch(e){}

                function onMoodUpdate(e){
                    const next = (e && e.detail) ? e.detail : safeParse(localStorage.getItem(STORAGE_KEY)) || []
                    setLogs(next)
                    try{ if (typeof renderMoodChart === 'function') renderMoodChart(next) } catch(e){}
                    try{ if (typeof renderLogsList === 'function') renderLogsList(next) } catch(e){}
                }
                window.addEventListener('moodHistoryUpdated', onMoodUpdate)
                window.addEventListener('storage', onMoodUpdate)
                window.addEventListener('restoreConversation', (e)=>{
                    const entry = e && e.detail ? e.detail : null
                    if (entry && entry.conversation) setMessages(entry.conversation)
                })
                return ()=>{
                    window.removeEventListener('moodHistoryUpdated', onMoodUpdate)
                    window.removeEventListener('storage', onMoodUpdate)
                }
            // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [])

            React.useEffect(()=>{ if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight }, [messages, isTyping, actions])

            // Consent banner mount
            React.useEffect(()=>{
                const stored = safeParse(localStorage.getItem('mf_consent'));
                if(stored){
                    setConsent({...stored, ready:true});
                    // Start session automatically once consent object exists (accepted or declined external NLP)
                    setSessionPhase('active');
                    pushIntro(stored);
                    return;
                }
                const cb = document.getElementById('consent-banner'); if(cb) cb.classList.remove('hidden');
                const form = document.getElementById('consent-form');
                const decline = document.getElementById('consent-decline');
                function finalize(accepted){
                    const nlp = accepted && document.getElementById('consent-nlp').checked;
                    const retain = accepted && document.getElementById('consent-retain').checked;
                    const analytics = accepted && document.getElementById('consent-analytics').checked;
                    const obj = { accepted, nlp, retain, analytics, ts: Date.now() };
                    localStorage.setItem('mf_consent', JSON.stringify(obj));
                    setConsent({...obj, ready:true});
                    if(cb) cb.classList.add('hidden');
                    if(!retain){ localStorage.removeItem('accessibleMoodHistory'); }
                    setSessionPhase('active');
                    pushIntro(obj);
                    analyticsEvent('consent_saved', obj);
                }
                form && form.addEventListener('submit', e=>{ e.preventDefault(); finalize(true); });
                decline && decline.addEventListener('click', ()=>finalize(false));
                return ()=>{
                    form && form.removeEventListener('submit', ()=>{});
                    decline && decline.removeEventListener('click', ()=>{});
                }
            },[])

            function pushIntro(cons){
                const privacyLine = cons.accepted ? (cons.nlp? 'If you enable external analysis, anonymized text may be processed.' : 'We will keep everything local in your browser.') : 'All processing will remain local and no external analysis will be used.';
                pushBot("Thanks for setting preferences. I'm here to listen and support. You can tell me how you're feeling or choose a starter. You can type 'end' anytime to wrap up.")
                pushBot(privacyLine)
            }

            function pushUser(text){
                setMessages(prev=>{
                    if(!firstUserMessageRef.current){
                        firstUserMessageRef.current = { text, ts: Date.now() }
                        analyticsEvent('first_message', { length: text.length, sample: text.toLowerCase().slice(0,60) })
                    }
                    return [...prev,{type:'user', text, time: formatMessageTime(new Date()), ts: Date.now()}]
                })
            }
            function pushBot(text, meta){ setMessages(prev=>[...prev,{type:'bot', text, meta, time: formatMessageTime(new Date()), ts: Date.now()}]) }
            
            function formatMessageTime(date) {
                const now = new Date();
                const isToday = date.getDate() === now.getDate() && 
                               date.getMonth() === now.getMonth() && 
                               date.getFullYear() === now.getFullYear();
                
                if (isToday) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + 
                           date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            }

            function addActions(list){ setActions(list.map(a=>({...a,id:crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2)}))); analyticsEvent('actions_shown',{labels:list.map(x=>x.label)}) }
            function clearActions(){ setActions([]) }

            const crisisPatterns = ['kill myself','end my life','suicide','hurt myself','cutting','no reason to live','i might harm']
            function detectCrisis(text){ const lt=(text||'').toLowerCase(); return crisisPatterns.some(p => lt.includes(p)) }

            function addLog(mood, note, meta){
                const entry = { date: nowDate(), mood: Number(mood), tags: (meta && meta.tags) || [], notes: note || '' }
                if (meta && meta.conversation) entry.conversation = meta.conversation
                if (meta && meta.starter) entry.starter = meta.starter
                const existing = logs.findIndex(l => l.date === entry.date)
                const next = existing !== -1 ? logs.slice().map((v,i)=> i===existing?entry:v) : [...logs, entry]
                persistLogs(next)
                analyzeInsights(next)
            }

            function handleSendText(raw){
                const text = raw || input
                if (!text || !text.trim()) return
                if(sessionPhase==='ended') { pushBot('Session has ended. Start a new session to continue.'); return }
                if(sessionPhase==='init'){ pushBot('Please review the privacy panel and accept or decline to begin.'); return }
                pushUser(text)
                setInput('')
                setIsTyping(true)
                // Session end detection (blocked if unresolved high risk state)
                const lt = text.toLowerCase();
                if(sessionPhase==='active' && /(end session|end|finish|stop|goodbye|bye)/.test(lt)) {
                    if(riskMeta.level==='high'){
                        setTimeout(()=>{ setIsTyping(false); pushBot('Before we wrap up, I want to be sure you are safe. Can you let me know if you have any thoughts of harming yourself right now?'); }, 400);
                        return;
                    }
                    setTimeout(()=>{ endSession(); }, 400); return;
                }
                // Decline / skip handling for last suggestion
                if(lastSuggestion && /(no|not now|skip|maybe later|another time)/.test(lt)) {
                    setLastSuggestion(null);
                    clearActions();
                    setTimeout(()=>{ setIsTyping(false); pushBot('Absolutely okay — I will just listen. Share anything you like.'); }, 400);
                    return;
                }
                const moodMatch = (text||'').match(/mood\s*[:\-]?\s*([1-5])(?:\s*[-–—]\s*(.+))?/i)
                if (moodMatch){ addLog(Number(moodMatch[1]), moodMatch[2] ? moodMatch[2].trim() : '', { conversation: messages.slice(), starter: lastStarterRef.current }); setIsTyping(false); pushBot('Saved to Your Logs.'); return }
                // (Legacy) Hashtag extraction for tag editor removed; conversation no longer tracks inline tags separately.
                setTimeout(async ()=>{
                    // Consent-gated sentiment adapter (async) then risk classify
                    let extScore = null;
                    if(consent.ready && consent.accepted && consent.nlp && typeof sentimentAdapter !== 'undefined') {
                        try {
                            const res = await sentimentAdapter.analyze(text, { session: sessionIdRef.current });
                            if(res && typeof res.score === 'number') extScore = res.score;
                        } catch(err){ /* swallow */ }
                    }
                    setIsTyping(false)
                    try {
                        if (typeof classifyRisk === 'function') {
                            const meta = classifyRisk(text, messages, extScore);
                            setRiskMeta(meta);
                            // High risk -> immediate safety protocol
                            if(meta.level==='high') { 
                                pushBot("I'm really sorry you're feeling this way — your safety is very important.");
                                if(core && core.promptDirectRiskCheck) { core.promptDirectRiskCheck(coreCtx); } else { offerHighRiskSupport(meta); }
                                if(core && core.reinforceAutonomy) { core.reinforceAutonomy(coreCtx); }
                                lastStarterRef.current=null; return; }
                            // Moderate risk -> grounding + clarifying question (gentle)
                            if(meta.level==='moderate') { 
                                pushBot('I hear a lot of strain. Would grounding or breathing help, or would you like to keep talking?');
                                if(core && core.promptDirectRiskCheck) { core.promptDirectRiskCheck(coreCtx); }
                                lastStarterRef.current=null; return; }
                        }
                    } catch(e){}
                    if (detectCrisis(text)){
                        pushBot("I'm really concerned by what you shared. If you're in immediate danger, please contact emergency services or a local hotline. Your safety matters.");
                        if(core && core.promptDirectRiskCheck) core.promptDirectRiskCheck(coreCtx);
                        if(core && core.reinforceAutonomy) core.reinforceAutonomy(coreCtx);
                        return;
                    }
                    const intent = detectIntent(text);
                    routeIntent(intent, text);
                    lastStarterRef.current = null
                }, 600)
            }

            function detectIntent(text){
                const t = (text||'').toLowerCase();
                if(/^(\s*)?(hi|hey|hello|hiya|yo|sup|what's up|whats up|good (morning|afternoon|evening))\b/.test(t)) return 'greeting';
                if(/anxi|panic|overwhelm|stress|stressed/.test(t)) return 'anxiety';
                if(/sleep|insomnia|tired/.test(t)) return 'sleep';
                if(/lonely|alone|isolat/.test(t)) return 'lonely';
                if(/no motivation|unmotivated|cant focus|can't focus/.test(t)) return 'motivation';
                if(/burn ?out|burned out|burnt out|exhausted/.test(t)) return 'burnout';
                if(/grief|loss|lost someone|passed away/.test(t)) return 'grief';
                if(/relationship|breakup|partner|argument/.test(t)) return 'relationship';
                if(/anger|furious|rage/.test(t)) return 'anger';
                if(/thank|thanks|appreciate/.test(t)) return 'gratitude';
                // New nuanced intents
                if(/life (has not|hasn't|isn't) (what i (thought|believed|expected)|what i expected)|lost (purpose|direction)|no (purpose|meaning)|meaningless|no meaning|nothing makes sense/.test(t)) return 'existential';
                if(/moving on (feels|is) (hard|difficult)|can't move on|cannot move on|stuck (on|moving)|hard to move on/.test(t)) return 'adjustment';
                if(/work (has felt|feels|is) (hard|difficult|overwhelming)|going to work (is|feels) (hard|difficult)|every ?day (to )?work (has felt|feels) (hard|difficult)|work stress|work is draining|drained by work/.test(t)) return 'work';
                return 'general';
            }

            function routeIntent(intent, raw){
                switch(intent){
                    case 'existential':
                        pushBot('It sounds like there is a gap between how you hoped life would feel and how it is right now. That mismatch can feel disorienting.');
                        addActions([
                            { label:'Explore what changed', handler: ()=>{ pushBot('If you like: What expectations or plans feel most different now? Writing a short list can clarify themes.'); clearActions(); } },
                            { label:'Clarify values', handler: ()=>{ pushBot('Try listing 3 things still meaningful (even if small). Micro-alignment steps often rebuild direction.'); clearActions(); } },
                            { label:'Tiny stabilizing step', handler: ()=>{ pushBot('Pick one gentle anchor for today (hydrate, short walk, message a friend). Small anchors reduce the sense of drift.'); clearActions(); } },
                            { label:'Just listen', handler: ()=>{ pushBot('I can simply listen while you describe more. Take your time.'); clearActions(); } }
                        ]);
                        break;
                    case 'adjustment':
                        pushBot('Moving on after change or loss can feel almost impossible — it usually means your mind is still processing the meaning of what happened.');
                        addActions([
                            { label:'Name what feels stuck', handler: ()=>{ pushBot('Complete this if you wish: "A part of me still holds onto ____ because ____". Naming it can soften the hold.'); clearActions(); } },
                            { label:'Gentle grief prompt', handler: ()=>{ pushBot('If grief is part of this: What is one quality or routine you miss that mattered? Honouring it is a form of forward motion.'); clearActions(); } },
                            { label:'Grounding', handler: startGrounding },
                            { label:'Just listen', handler: ()=>{ pushBot('I am here — you can describe the difficult parts at your own pace.'); clearActions(); } }
                        ]);
                        break;
                    case 'work':
                        pushBot('Work feeling difficult day after day can drain motivation and signal rising strain or early burnout. Want to explore or try a micro-adjustment?');
                        addActions([
                            { label:'Quick stress scan', handler: ()=>{ pushBot('List: (1) Top 2 draining tasks (2) One resource/support you do have (3) One boundary or 5-min recovery you could try today.'); clearActions(); } },
                            { label:'Micro-boundary tip', handler: ()=>{ pushBot('Example micro-boundary: a 3-min pause before switching tasks or a single clear “done for today” ritual. Tiny endings help recovery.'); clearActions(); } },
                            { label:'Grounding break', handler: startGrounding },
                            { label:'Just listen', handler: ()=>{ pushBot('Okay — describe what a hard workday has been like. I will stay with you in that.'); clearActions(); } }
                        ]);
                        break;
                    case 'anxiety':
                        pushBot('That sounds stressful. Would a brief grounding or breathing exercise be helpful?');
                        setLastSuggestion('grounding');
                        addActions([
                            { label:'Try grounding', handler: startGrounding },
                            { label:'Show breathing', handler: startBreathing },
                            { label:'Just listen', handler: ()=>{ pushBot('Okay, I am here. Share anything that feels important.'); clearActions(); } }
                        ]);
                        break;
                    case 'sleep':
                        pushBot('Sleep struggles can be hard. Sometimes a gentle wind-down routine helps. Want a quick tip?');
                        setLastSuggestion('sleep-tip');
                        addActions([
                            { label:'Give a tip', handler: ()=>{ pushBot('Try a 5-minute screen-free break and a slow exhale pattern (4 in, 6 out) to cue rest.'); clearActions(); } },
                            { label:'Not now', handler: ()=>{ pushBot('No problem. We can revisit later.'); clearActions(); } }
                        ]);
                        break;
                    case 'lonely':
                        pushBot('Feeling lonely is tough. Would exploring supportive community options help?');
                        setLastSuggestion('community');
                        addActions([
                            { label:'Suggest resources', handler: ()=>{ pushBot('Consider peer support lines or moderated online communities focused on shared interests.'); clearActions(); } },
                            { label:'Skip', handler: ()=>{ pushBot('Alright. I can simply listen.'); clearActions(); } }
                        ]);
                        break;
                    case 'motivation':
                        pushBot('Motivation dips happen. Want a tiny action planning prompt?');
                        setLastSuggestion('action-plan');
                        addActions([
                            { label:'Yes plan', handler: ()=>{ pushBot('Pick one task under 5 min. After finishing, send me "done" and we can reflect.'); clearActions(); } },
                            { label:'Skip', handler: ()=>{ pushBot('Understood. Take your time.'); clearActions(); } }
                        ]);
                        break;
                    case 'burnout':
                        pushBot('Burnout feelings can build slowly. Would a tiny recovery micro-step (rest, hydration, brief walk) help?');
                        setLastSuggestion('burnout');
                        addActions([
                            { label:'Suggest micro-step', handler: ()=>{ pushBot('Try a 2-minute pause: stand, stretch, slow exhale. Small resets matter.'); clearActions(); } },
                            { label:'Skip', handler: ()=>{ pushBot('Okay — we can just keep talking.'); clearActions(); } }
                        ]);
                        break;
                    case 'grief':
                        pushBot('I hear grief in what you shared. There is no right timetable. Would grounding or a remembrance prompt help?');
                        addActions([
                            { label:'Grounding', handler: startGrounding },
                            { label:'Remembrance prompt', handler: ()=>{ pushBot('If it feels okay: What is one comforting memory you’d like to hold for a moment?'); clearActions(); } },
                            { label:'Just listen', handler: ()=>{ pushBot('I’m here and listening.'); clearActions(); } }
                        ]);
                        break;
                    case 'relationship':
                        pushBot('Relationship stress can be heavy. Want a brief communication tip or coping strategy?');
                        addActions([
                            { label:'Communication tip', handler: ()=>{ pushBot('Try “I feel … when … because …” to express needs without blame.'); clearActions(); } },
                            { label:'Coping strategy', handler: ()=>{ pushBot('Short pause + grounding before responding can reduce escalation.'); clearActions(); } },
                            { label:'Skip', handler: ()=>{ pushBot('Okay — share more if you wish.'); clearActions(); } }
                        ]);
                        break;
                    case 'anger':
                        pushBot('Anger can signal unmet needs. Would paced breathing or a reframing prompt help?');
                        addActions([
                            { label:'Paced breathing', handler: startBreathing },
                            { label:'Reframing prompt', handler: ()=>{ pushBot('What need of yours feels threatened right now? Naming it can reduce intensity.'); clearActions(); } },
                            { label:'Skip', handler: ()=>{ pushBot('Alright. I can stay with you while you process.'); clearActions(); } }
                        ]);
                        break;
                    case 'gratitude':
                        pushBot('I appreciate you too. Anything else you’d like to explore or should we begin wrapping up?');
                        break;
                    case 'greeting':
                        if(!greetedRef.current) greetedRef.current = true;
                        pushBot('Hi there — I’m here with you. Share anything, pick a starter, or tap “Not sure what to say”.');
                        addActions([
                            { label:'Feeling stressed', handler: ()=>{ pushBot('Stress can really build. Want grounding or breathing?'); addActions([{label:'Grounding',handler:startGrounding},{label:'Breathing',handler:startBreathing},{label:'Just listen',handler:()=>{ pushBot('I can just listen — take your time.'); clearActions(); }}]); } },
                            { label:'Feeling low', handler: ()=>{ pushBot('Feeling low can be draining. A tiny supportive step or just space to talk — either is okay.'); clearActions(); } },
                            { label:'Just checking in', handler: ()=>{ pushBot('Alright — how have you been feeling lately?'); clearActions(); } }
                        ]);
                        break;
                    default:
                        // Light theme cues to make reflection more structured
                        const lt = (raw||'').toLowerCase();
                        const themes=[];
                        if(/work|office|job/.test(lt)) themes.push('work strain');
                        if(/tired|exhaust|drained/.test(lt)) themes.push('energy depletion');
                        if(/lost|direction|purpose|meaning/.test(lt)) themes.push('direction/purpose');
                        if(/hard to move on|moving on|stuck/.test(lt)) themes.push('adjustment grief');
                        const themeLine = themes.length ? `I’m hearing possible themes: ${themes.join(', ')}. ` : '';
                        pushBot(themeLine + 'If it helps, you can share: (1) roughly how long this has felt this way, (2) what part feels most heavy, or (3) one tiny thing that has still helped a little. I can then suggest a micro-step.');
                        addActions([
                            { label:'Duration', handler: ()=>{ pushBot('How long has this been present (days, weeks, months)?'); clearActions(); } },
                            { label:'Heaviest part', handler: ()=>{ pushBot('What part of this feels heaviest on most days?'); clearActions(); } },
                            { label:'Tiny help', handler: ()=>{ pushBot('Name one small thing that helps even slightly (tea, music, stepping outside). We can build from it.'); clearActions(); } }
                        ]);
                }
            }

            function maybeOfferGrounding(){
                if(lastSuggestion==='grounding') return;
                setLastSuggestion('grounding');
                pushBot('That sounds really tough. Would a short grounding exercise help?');
                addActions([
                    { label:'Yes grounding', handler: startGrounding },
                    { label:'Breathing', handler: startBreathing },
                    { label:'No thanks', handler: ()=>{ pushBot('Okay — I will just stay with you in this. Share anything you like.'); clearActions(); } }
                ]);
            }

            function offerHighRiskSupport(meta){
                if(escalation.offered) { pushBot('Please choose: hotline info, grounding, or just talk.'); return }
                setEscalation(prev=>({...prev, offered:true}));
                pushBot("I sense this may be urgent. You're not alone. I can show hotline info, guide grounding, or just listen. What would you like?");
                addActions([
                    { label:'Hotline info', handler: showHotlines },
                    { label:'Grounding', handler: startGrounding },
                    { label:'Just listen', handler: ()=>{ pushBot('I will stay with you here. Type anything that comes up.'); clearActions(); } }
                ]);
            }

            function showHotlines(){
                clearActions();
                const region = localStorage.getItem('hotlineRegion')||'us';
                const map={
                    us:'988 (Suicide & Crisis Lifeline) — call or text 988',
                    uk:'Samaritans: 116 123',
                    ca:'988 (Talk Suicide Canada)',
                    au:'Lifeline: 13 11 14'
                };
                pushBot(`Here are hotline details (${region.toUpperCase()}): ${map[region]||map.us}. If you are in immediate danger, contact local emergency services.`);
                setEscalation(prev=>({...prev, accepted:true}));
            }

            function startGrounding(){
                clearActions();
                pushBot('Let’s try a 5-4-3-2-1 grounding. Ready? (You can type stop anytime)');
                setTimeout(()=>pushBot('Name 5 things you can see.'), 800);
                setTimeout(()=>pushBot('Great. Now 4 things you can touch.'), 5000);
                setTimeout(()=>pushBot('Now 3 things you can hear.'), 9500);
                setTimeout(()=>pushBot('Next 2 things you can smell or like the scent of.'), 14000);
                setTimeout(()=>pushBot('Finally 1 thing you appreciate about yourself right now.'), 18500);
                setTimeout(()=>{ pushBot('How do you feel now? A tiny shift counts.'); }, 24000);
            }

            function startBreathing(){
                clearActions();
                pushBot('Let’s do a brief paced breathing: Inhale 4, hold 2, exhale 6. I’ll count a few cycles.');
                let cycle=0;
                function step(){
                    if(cycle>=3){ pushBot('Nice work. Notice any small change in tension?'); return }
                    cycle++;
                    pushBot(`Cycle ${cycle}: Inhale (4) ... Hold (2) ... Exhale (6).`);
                    setTimeout(step, 6000);
                }
                setTimeout(step, 800);
            }

            function endSession(){
                if(riskMeta.level==='high'){
                    pushBot('Before we close, I want to be sure you are safe. Are you having any thoughts of harming yourself right now?');
                    if(core && core.promptDirectRiskCheck) { core.promptDirectRiskCheck(coreCtx); }
                    if(core && core.reinforceAutonomy) { core.reinforceAutonomy(coreCtx); }
                    return;
                }
                const userMsgs = messages.filter(m=>m.type==='user').length;
                const today = logs.find(l=>l.date===nowDate());
                pushBot(`Session summary: ${userMsgs} messages shared${today? ', mood saved today at level '+today.mood:''}. Remember this space is not clinical care but a reflective aid.`);
                pushBot('You can clear this conversation or start fresh. Take care of yourself.');
                setSessionPhase('ended');
                analyticsEvent('session_end',{userMsgs});
                addActions([
                    { label:'Start new session', handler: ()=>{ setMessages([]); setSessionPhase('active'); pushIntro(consent); clearActions(); } },
                    { label:'Clear & close', handler: ()=>{ setMessages([]); setSessionPhase('ended'); clearActions(); } }
                ]);
            }
            function analyticsEvent(name, payload){
                try { const c = consent||{}; if(!c.analytics) return; window._mfAnalytics = window._mfAnalytics||[]; window._mfAnalytics.push({ts:Date.now(), name, payload}); } catch(e){}
            }
            window._mfTest = window._mfTest || {}; window._mfTest.detectIntent = detectIntent;

            // Removed legacy mood/tag editing functions (addTagFromInput, removeTag, saveMoodEntry)
            // These were part of the previous inline mood logging UI. Conversation flow now
            // logs context automatically; tags & explicit mood save actions deprecated.

            function analyzeInsights(allLogs){
                if(!insightsEnabled) return; // respect user preference
                if(!allLogs.length) return;
                const recent = allLogs.slice(-7);
                const lows = recent.filter(l=>l.mood <=2).length;
                const highs = recent.filter(l=>l.mood >=4).length;
                const avg = (recent.reduce((a,b)=>a+(b.mood||0),0)/recent.length).toFixed(2);
                const sig = `${recent.length}|${lows}|${highs}|${avg}`;
                if(sig===lastInsightSig) return;
                // Choose one insight message based on pattern priority
                let msg=null;
                if(lows >=3) msg = 'Noticing several low moods this week. Would a small grounding activity help?';
                else if(highs >=3) msg = 'Nice streak of higher moods recently—maybe journal what contributed?';
                else if(avg && recent.length>=5) msg = `Your 7-day average mood is ${avg}. Want to set a gentle goal?`;
                if(msg){ pushBot(msg,{insight:true}); setLastInsightSig(sig); }
            }

            function handleInlineFormSubmit(e){
                e && e.preventDefault && e.preventDefault()
                const mood = document.querySelector('input[name="mf-mood"]:checked')
                const tags = (document.getElementById('mf-tags') && document.getElementById('mf-tags').value) || ''
                const notes = (document.getElementById('mf-notes') && document.getElementById('mf-notes').value) || ''
                if (!mood){ try{ if (typeof showToast === 'function') showToast('Select a mood before saving', 'warn') } catch(e){}; return }
                addLog(Number(mood.value), notes, { conversation: messages.slice(), starter: currentStarter, tags: tags.split(',').map(t=>t.trim()).filter(Boolean) })
                try{ if (typeof showToast === 'function') showToast('Check-in saved', 'success') } catch(e){}
            }

            function clearLogs(){ if (!confirm('Clear all saved mood logs?')) return; persistLogs([]); pushBot('Your saved mood logs have been cleared.') }
            function resetConversation(){ if (!confirm('Reset conversation?')) return; try { const snapshot = { date: nowDate(), mood: null, notes: '', conversation: messages.slice() }; persistLogs([...logs, snapshot]) } catch (e){}; setMessages([]); pushBot('Conversation reset.') }

            // Personalization state
            const [showPrefs,setShowPrefs] = React.useState(false)
            const [showPrivacy,setShowPrivacy] = React.useState(false)
            const [panicMode,setPanicMode] = React.useState(false)
            const [prefs,setPrefs] = React.useState(()=> safeParse(localStorage.getItem('mf_prefs')) || { tone:'neutral', pacing:'normal' })
            const pacingMap={ slow:1.4, normal:1, fast:0.7 }
            const pacingFactor = pacingMap[prefs.pacing] || 1

            // Core module
            const core = window.conversationCore
            const startOptions = core ? core.getStartOptions() : []
            
            // Add icons to start options if they don't have them
            const iconMap = {
                'Feeling anxious': 'psychiatry',
                'Feeling low': 'sentiment_sad',
                'Need to talk': 'forum',
                'Trouble sleeping': 'bedtime',
                'Feeling overwhelmed': 'air',
                'Work stress': 'work',
                'Relationship issue': 'group',
                'Just checking in': 'emoji_emotions'
            }
            
            startOptions.forEach(option => {
                if (!option.icon) {
                    option.icon = iconMap[option.label] || 'chat';
                }
            })

            function pushBot(text, meta){
                const toned = core ? core.applyTone(prefs.tone, text) : text
                setMessages(prev=>[...prev,{type:'bot', text: toned, meta}])
            }

            // Replace previous pushBot definition above (safe no-op here)

            function savePrefs(next){ setPrefs(next); localStorage.setItem('mf_prefs', JSON.stringify(next)); try{ showToast && showToast('Preferences saved') }catch(e){} }
            function togglePanic(){ setPanicMode(p=>!p); setTimeout(()=>{ if(!document.body) return; if(!panicMode){ document.body.classList.add('panic-safe'); } else { document.body.classList.remove('panic-safe'); } },0) }
            React.useEffect(()=>{ const btn=document.getElementById('panic-return'); if(btn) btn.onclick=()=>{ if(document.body.classList.contains('panic-safe')){ document.body.classList.remove('panic-safe'); setPanicMode(false) } } },[])

            const coreCtx = {
                pushBot,
                addActions,
                clearActions,
                setLastSuggestion,
                get lastSuggestion(){ return lastSuggestion },
                startGrounding: ()=> core.startGrounding(coreCtx),
                startBreathing: ()=> core.startBreathing(coreCtx),
                showHotlines: ()=> core.showHotlines(coreCtx),
                endSession: ()=> core.endSession(coreCtx), // core-level (still guarded above)
                promptDirectRiskCheck: ()=> core.promptDirectRiskCheck && core.promptDirectRiskCheck(coreCtx),
                reinforceAutonomy: ()=> core.reinforceAutonomy && core.reinforceAutonomy(coreCtx),
                setEscalation,
                escalation,
                consent,
                get pacingFactor(){ return pacingFactor },
                logs,
                setSessionPhase,
                messages,
                addLog,
                analyticsEvent,
                resetConversation: ()=> { setMessages([]); pushIntro(consent); }
            }

            function startGrounding(){ core.startGrounding(coreCtx) }
            function startBreathing(){ core.startBreathing(coreCtx) }
            function showHotlines(){ core.showHotlines(coreCtx) }
            function endSession(){ core.endSession(coreCtx) }

            // Expose for tests
            window._mfTest = window._mfTest || {}; window._mfTest.detectIntent = core.detectIntent; window._mfTest.handleSend = handleSendText;

            function exportData(){
                try {
                    const bundle={
                        logs: safeParse(localStorage.getItem(STORAGE_KEY))||[],
                        consent: safeParse(localStorage.getItem('mf_consent'))||null,
                        prefs: safeParse(localStorage.getItem('mf_prefs'))||null,
                        analytics: window._mfAnalytics||[]
                    };
                    const blob=new Blob([JSON.stringify(bundle,null,2)],{type:'application/json'});
                    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='mindflow-data.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500);
                }catch(e){ showToast && showToast('Export failed','warn'); }
            }
            function clearAll(){ if(!confirm('Clear logs, conversation, consent & prefs?')) return; localStorage.removeItem(STORAGE_KEY); localStorage.removeItem('mf_consent'); localStorage.removeItem('mf_prefs'); setMessages([]); setLogs([]); showToast && showToast('All local data cleared','warn'); }

            return (
                <div className="mindflow-container">
                    <div className="mindflow-header">
                        <div className="logo-area">
                            <div className="app-logo"><span className="material-symbols-rounded">psychology</span></div>
                            <div>
                                <h3 className="app-title">Mind Flow</h3>
                                <p className="app-tagline">A calm space for reflection & support</p>
                            </div>
                        </div>
                        <div className="theme-toggle">
                            <button type="button" className="icon-button" onClick={() => {
                                const html = document.documentElement;
                                const currentTheme = html.getAttribute('data-theme') || 'light';
                                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                                html.setAttribute('data-theme', newTheme);
                                localStorage.setItem('mf_theme', newTheme);
                                analyticsEvent('theme_changed', { theme: newTheme });
                            }}>
                                <span className="material-symbols-rounded">
                                    {document.documentElement.getAttribute('data-theme') === 'dark' ? 'light_mode' : 'dark_mode'}
                                </span>
                            </button>
                        </div>
                    </div>

                    <div className="card mindflow-card" data-sensitive>
                        {/* Quick start prompts moved inside chat area for logical placement */}
                        <div style={{ background:'rgba(0,0,0,0.04)', padding:'8px 10px', borderRadius:8, marginTop:10, fontSize:11, lineHeight:1.4 }}>
                            This assistant is not a substitute for professional diagnosis or emergency services. Risk level: <strong>{riskMeta.level}</strong>{riskMeta.level!=='normal' ? ` (sentiment ${riskMeta.score})` : ''}.
                        </div>

                        <div style={{ marginTop:14, display:'flex', gap:8, flexWrap:'wrap', alignItems:'center' }}>
                            <button type="button" className="control-btn insights-toggle" aria-pressed={insightsEnabled} aria-label={insightsEnabled? 'Disable automated mood insights' : 'Enable automated mood insights'} title={insightsEnabled? 'Disable automated mood insights' : 'Enable automated mood insights'} onClick={()=>{ const next=!insightsEnabled; setInsightsEnabled(next); localStorage.setItem('mf_insights_enabled', String(next)); if(!next){ showToast && showToast('Insights disabled','warn'); } else { showToast && showToast('Insights enabled'); analyzeInsights(logs);} }}>
                                {insightsEnabled? 'Disable Insights' : 'Enable Insights'}
                            </button>
                            <button type="button" className="control-btn" onClick={()=>{ setMessages([]); setSessionPhase('active'); pushBot('New session started. Share anything when ready.'); analyticsEvent('session_restart'); }}>New Session</button>
                            <button type="button" className="control-btn" onClick={()=>{ showHotlines(); analyticsEvent('emergency_exit'); }}>Emergency Exit</button>
                            <button type="button" className="control-btn" onClick={()=>togglePanic()}>{panicMode? 'Restore View' : 'Quick Hide'}</button>
                            <button type="button" className="control-btn" onClick={()=> setShowPrefs(p=>!p)}>{showPrefs? 'Close Personalize' : 'Personalize'}</button>
                            <button type="button" className="control-btn" onClick={()=> setShowPrivacy(p=>!p)}>{showPrivacy? 'Close Data' : 'Data & Privacy'}</button>
                            <span style={{ fontSize:10, opacity:.55 }}>Insights are simple pattern notices, not a diagnosis.</span>
                        </div>

                        <div ref={scrollRef} className="chat-container" data-sensitive-chat>
                            {messages.length === 0 && (
                                <div className="empty-chat-container">
                                    <div className="welcome-illustration">
                                        <span className="material-symbols-rounded">chat</span>
                                    </div>
                                    <h4 className="welcome-title">How would you like to begin?</h4>
                                    <div className="start-chips" role="list" aria-label="Conversation starters">
                                        {startOptions.map((opt,i)=> (
                                            <button role="listitem" key={i} className="start-chip" onClick={()=>{ lastStarterRef.current=opt.label; setCurrentStarter(opt.label); handleSendText(opt.text); }}>
                                                <span className="chip-icon material-symbols-rounded">{opt.icon || 'chat'}</span>
                                                <span className="chip-text">{opt.label}</span>
                                            </button>
                                        ))}
                                        <button role="listitem" className="start-chip featured-chip" onClick={()=>{
                                            pushBot('Totally okay not to know where to begin. Here are a few gentle prompts:');
                                            addActions([
                                                { label:'Describe today so far', handler:()=>{ handleSendText('Today has felt ...'); } },
                                                { label:'Name one feeling', handler:()=>{ handleSendText('I feel ...'); } },
                                                { label:'Something draining me', handler:()=>{ handleSendText('One thing draining me is ...'); } },
                                                { label:'Skip prompts', handler:()=>{ pushBot('All good — we can just sit here until something comes.'); clearActions(); } }
                                            ]);
                                        }}>
                                            <span className="chip-icon material-symbols-rounded">help</span>
                                            <span className="chip-text">Not sure what to say</span>
                                        </button>
                                    </div>
                                    <p className="start-hint">Or just start typing anything on your mind.</p>
                                </div>
                            )}
                            <div className="message-list">
                                {messages.map((m, idx) => (
                                    <div key={idx} className={`message-row ${m.type==='user'?'user-message':'bot-message'}`}>
                                        <div className={`message-bubble ${m.type==='user'?'user':'bot'} ${m.meta?.insight ? 'insight-message' : ''}`}>
                                            {m.meta?.insight && <span className="message-badge"><span className="material-symbols-rounded">lightbulb</span></span>}
                                            {m.text}
                                        </div>
                                        <div className="message-time">{m.time || ''}</div>
                                    </div>
                                ))}
                                {isTyping && (
                                    <div className="message-row bot-message">
                                        <div className="message-bubble bot typing">
                                            <span className="typing-dot"></span>
                                            <span className="typing-dot"></span>
                                            <span className="typing-dot"></span>
                                        </div>
                                    </div>
                                )}
                            </div>
                            {actions.length>0 && <div className="action-chips" aria-label="Suggested actions" role="group">
                                {actions.map(a=> <button key={a.id} className="action-chip" onClick={()=>{ a.handler(); }}>{a.label}</button>)}
                            </div>}
                        </div>
                        <div className="chat-footer">
                            <div className="message-input-container">
                                <div className="emoji-menu-trigger">
                                    <button className="icon-button" title="Quick mood emoji" onClick={() => alert('Emoji selector would open here')}>😊</button>
                                </div>
                                <div className="input-wrapper">
                                    <input 
                                        className="message-input"
                                        value={input} 
                                        onChange={e=>setInput(e.target.value)} 
                                        onKeyDown={e=>e.key==='Enter' && handleSendText()} 
                                        placeholder={sessionPhase==='init' ? 'Review privacy to begin...' : (sessionPhase==='ended' ? 'Session ended — start new session?' : 'Type your message here...')} 
                                        disabled={sessionPhase==='init' || sessionPhase==='ended'} 
                                    />
                                    {input.trim() && <button className="input-clear" onClick={() => setInput('')}>
                                        <span className="material-symbols-rounded">close</span>
                                    </button>}
                                </div>
                                <button 
                                    onClick={()=>handleSendText()} 
                                    className={`send-button ${!input.trim() ? 'disabled' : ''}`}
                                    disabled={!input.trim()}
                                >
                                    <span className="material-symbols-rounded">send</span>
                                </button>
                            </div>
                            <div className="session-actions">
                                <button onClick={resetConversation} className="session-action-btn">
                                    <span className="material-symbols-rounded">refresh</span>
                                    <span>Reset chat</span>
                                </button>
                                <button type="button" className="session-action-btn" onClick={()=>endSession()}>
                                    <span className="material-symbols-rounded">logout</span>
                                    <span>End Session</span>
                                </button>
                                <button onClick={clearLogs} className="session-action-btn">
                                    <span className="material-symbols-rounded">delete</span>
                                    <span>Clear logs</span>
                                </button>
                            </div>
                                                </div>
                                                {showPrefs && (
                                                    <div className="prefs-panel" aria-label="Personalization settings">
                                                        <h4>Personalize</h4>
                                                        <div className="prefs-grid">
                                                            <label>Tone
                                                                <select value={prefs.tone} onChange={e=> savePrefs({...prefs, tone:e.target.value})}>
                                                                    <option value="neutral">Neutral</option>
                                                                    <option value="gentle">Gentle</option>
                                                                    <option value="motivating">Motivating</option>
                                                                </select>
                                                            </label>
                                                            <label>Pacing
                                                                <select value={prefs.pacing} onChange={e=> savePrefs({...prefs, pacing:e.target.value})}>
                                                                    <option value="normal">Normal</option>
                                                                    <option value="slow">Slow</option>
                                                                    <option value="fast">Fast</option>
                                                                </select>
                                                            </label>
                                                        </div>
                                                        <p style={{fontSize:11, marginTop:10, opacity:.7}}>Tone lightly decorates supportive messages. Pacing adjusts exercise timing.</p>
                                                    </div>
                                                )}
                                                {showPrivacy && (
                                                    <div className="privacy-panel" aria-label="Data and privacy controls">
                                                        <h4>Data & Privacy</h4>
                                                        <p style={{margin:'4px 0 8px', fontSize:12}}>Export or clear your locally stored data.</p>
                                                        <div style={{display:'flex', gap:8, flexWrap:'wrap'}}>
                                                            <button type="button" className="control-btn small" onClick={exportData}>Export JSON</button>
                                                            <button type="button" className="control-btn small" onClick={()=>{ if(!confirm('Clear mood logs?')) return; persistLogs([]); }}>Clear Logs</button>
                                                            <button type="button" className="control-btn small" onClick={()=>{ if(!confirm('Clear conversation messages?')) return; setMessages([]); }}>Clear Conversation</button>
                                                            <button type="button" className="control-btn small" onClick={clearAll}>Clear All</button>
                                                        </div>
                                                        <p style={{fontSize:10, marginTop:8, opacity:.6}}>All processing happens locally unless you opted into external analysis.</p>
                                                    </div>
                                                )}
                    </div>
                </div>
            )
        }

    ReactDOM.createRoot(document.getElementById('mind-flow-root')).render(<MindFlow />)
        </script>
        </div><!-- /legacy-app -->
    </body>
</html>
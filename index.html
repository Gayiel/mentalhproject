<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Mind Flow — MoodHouse</title>
        <link rel="stylesheet" href="style.css" />
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
        <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    </head>
    <body>
        <a class="skip-link" href="#mind-flow-root">Skip to main content</a>

        <header class="topbar" role="banner" aria-label="Top navigation">
            <div class="topbar-left">
                <div class="avatar" aria-hidden="true">MH</div>
                <div class="brand">
                    <strong class="brand-title">MoodHouse</strong>
                    <span class="brand-sub">Daily Check-in</span>
                </div>
            </div>
            <nav class="top-actions" aria-label="Profile actions">
                <button id="toggle-soft-btn" class="control-btn" aria-pressed="false" title="Toggle softer colors">Softer colors</button>
                <button class="icon-btn" aria-label="Settings">⚙️</button>
            </nav>
        </header>

        <div class="site-hero">
            <h1>Mind Flow</h1>
            <p>A private, accessible place to track how you feel and find guidance when needed.</p>
        </div>

        <main id="mood-app-container">

            <!-- Mind Flow replaces the old 'How are you feeling today?' logger -->
            <section id="mind-flow" aria-labelledby="mind-flow-title" class="card">
                <h2 id="mind-flow-title">Mind Flow</h2>
                <div id="mind-flow-root"></div>
            </section>

            <aside id="resource-banner" class="alert-banner hidden" role="alert" aria-live="polite">
                <p>It looks like you've logged a challenging mood pattern. <strong>Immediate, affordable support is available.</strong></p>
                <a href="resources.html" class="secondary-btn">Access Guided Resources</a>
            </aside>

            <section id="mood-history" aria-labelledby="history-title" class="card">
                <div class="history-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                    <h2 id="history-title" style="margin:0">Your Mood Trends</h2>
                    <div>
                        <button id="toggle-history-btn" class="control-btn" aria-expanded="true" aria-controls="mood-chart-container log-list">Collapse</button>
                    </div>
                </div>

                <div class="filter-controls">
                    <button id="view-7-day" class="control-btn active" aria-controls="mood-chart">7-Day Trend</button>
                    <button id="view-30-day" class="control-btn" aria-controls="mood-chart">Monthly Summary</button>
                    <button id="find-support-btn" class="control-btn" type="button">Find Nearby Support</button>
                </div>

                <div id="mood-chart-container" class="chart-container">
                    <canvas id="mood-chart" role="img" aria-label="Interactive line graph displaying your daily average mood score." aria-describedby="chart-desc"></canvas>
                    <p id="chart-desc" class="sr-only">This chart shows the recent trend of your daily mood scores. Higher values represent better mood.</p>
                    <div id="no-data" class="no-data" aria-hidden="true">No mood logs yet. Your entries will appear here.</div>
                </div>

                <div id="log-list" class="card" aria-live="polite">
                    <h3>Your Logs</h3>
                    <div id="logs-container">
                        <p class="text-muted">No logs yet. Your entries will appear here.</p>
                    </div>
                </div>
            </section>

        </main>

        <footer class="page-footer" role="contentinfo">
            <p>Private &middot; For self-reflection and to help connect to resources when needed.</p>
        </footer>

        <div id="toast-area" aria-live="polite" aria-atomic="true"></div>

        <script src="script.js"></script>

        <!-- Mind Flow React component (Babel) -->
        <script type="text/babel">
        // Mind Flow component — single copy
        const STORAGE_KEY = 'accessibleMoodHistory';
        function safeParse(json){ try { return JSON.parse(json) } catch(e) { return null } }
        function nowDate(){ return new Date().toISOString().slice(0,10) }

        function MindFlow(){
            const [logs, setLogs] = React.useState(() => safeParse(localStorage.getItem(STORAGE_KEY)) || [])
            const [input, setInput] = React.useState('')
            const [messages, setMessages] = React.useState([])
            const [isTyping, setIsTyping] = React.useState(false)
            const [currentStarter, setCurrentStarter] = React.useState(null)
            const scrollRef = React.useRef(null)
            const lastStarterRef = React.useRef(null)

            const startOptions = [
                { label: 'Just checking in', text: "Just checking in — wondering how I'm doing today." },
                { label: 'Feeling stressed', text: "I've been feeling stressed and overwhelmed." },
                { label: 'Feeling low', text: "Lately I've been feeling a bit low and unmotivated." },
                { label: 'Need urgent help', text: "I might need urgent help — I'm worried about my safety." }
            ]

            function persistLogs(next){
                localStorage.setItem(STORAGE_KEY, JSON.stringify(next))
                setLogs(next)
                try{ if (typeof renderMoodChart === 'function') renderMoodChart(next) } catch(e){}
                try{ if (typeof renderLogsList === 'function') renderLogsList(next) } catch(e){}
                try{ window.dispatchEvent(new CustomEvent('moodHistoryUpdated',{detail: next})) } catch(e){}
                try{ if (typeof showToast === 'function') showToast('Saved to Your Logs') } catch(e){}
            }

            React.useEffect(()=>{
                pushBot("Hi — I'm Mind Flow. How can I help you today? You can try one of the quick starters below.")
                try{ if (typeof renderMoodChart === 'function') renderMoodChart(logs) } catch(e){}
                try{ if (typeof renderLogsList === 'function') renderLogsList(logs) } catch(e){}

                function onMoodUpdate(e){
                    const next = (e && e.detail) ? e.detail : safeParse(localStorage.getItem(STORAGE_KEY)) || []
                    setLogs(next)
                    try{ if (typeof renderMoodChart === 'function') renderMoodChart(next) } catch(e){}
                    try{ if (typeof renderLogsList === 'function') renderLogsList(next) } catch(e){}
                }
                window.addEventListener('moodHistoryUpdated', onMoodUpdate)
                window.addEventListener('storage', onMoodUpdate)
                window.addEventListener('restoreConversation', (e)=>{
                    const entry = e && e.detail ? e.detail : null
                    if (entry && entry.conversation) setMessages(entry.conversation)
                })
                return ()=>{
                    window.removeEventListener('moodHistoryUpdated', onMoodUpdate)
                    window.removeEventListener('storage', onMoodUpdate)
                }
            // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [])

            React.useEffect(()=>{ if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight }, [messages, isTyping])

            function pushUser(text){ setMessages(prev=>[...prev,{type:'user', text}]) }
            function pushBot(text, meta){ setMessages(prev=>[...prev,{type:'bot', text, meta}]) }

            const crisisPatterns = ['kill myself','end my life','suicide','hurt myself','cutting','no reason to live','i might harm']
            function detectCrisis(text){ const lt=(text||'').toLowerCase(); return crisisPatterns.some(p => lt.includes(p)) }

            function addLog(mood, note, meta){
                const entry = { date: nowDate(), mood: Number(mood), tags: (meta && meta.tags) || [], notes: note || '' }
                if (meta && meta.conversation) entry.conversation = meta.conversation
                if (meta && meta.starter) entry.starter = meta.starter
                const existing = logs.findIndex(l => l.date === entry.date)
                const next = existing !== -1 ? logs.slice().map((v,i)=> i===existing?entry:v) : [...logs, entry]
                persistLogs(next)
            }

            function handleSendText(raw){
                const text = raw || input
                if (!text || !text.trim()) return
                pushUser(text)
                setInput('')
                setIsTyping(true)
                const moodMatch = (text||'').match(/mood\s*[:\-]?\s*([1-5])(?:\s*[-–—]\s*(.+))?/i)
                if (moodMatch){ addLog(Number(moodMatch[1]), moodMatch[2] ? moodMatch[2].trim() : '', { conversation: messages.slice(), starter: lastStarterRef.current }); setIsTyping(false); pushBot('Saved to Your Logs.'); return }
                setTimeout(()=>{
                    setIsTyping(false)
                    if (detectCrisis(text)){ pushBot("I'm worried by what you shared. If you're in immediate danger, call emergency services."); return }
                    pushBot('Thanks for sharing — can you tell me how long you\'ve felt like this?')
                    lastStarterRef.current = null
                }, 600)
            }

            function handleInlineFormSubmit(e){
                e && e.preventDefault && e.preventDefault()
                const mood = document.querySelector('input[name="mf-mood"]:checked')
                const tags = (document.getElementById('mf-tags') && document.getElementById('mf-tags').value) || ''
                const notes = (document.getElementById('mf-notes') && document.getElementById('mf-notes').value) || ''
                if (!mood){ try{ if (typeof showToast === 'function') showToast('Select a mood before saving', 'warn') } catch(e){}; return }
                addLog(Number(mood.value), notes, { conversation: messages.slice(), starter: currentStarter, tags: tags.split(',').map(t=>t.trim()).filter(Boolean) })
                try{ if (typeof showToast === 'function') showToast('Check-in saved', 'success') } catch(e){}
            }

            function clearLogs(){ if (!confirm('Clear all saved mood logs?')) return; persistLogs([]); pushBot('Your saved mood logs have been cleared.') }
            function resetConversation(){ if (!confirm('Reset conversation?')) return; try { const snapshot = { date: nowDate(), mood: null, notes: '', conversation: messages.slice() }; persistLogs([...logs, snapshot]) } catch (e){}; setMessages([]); pushBot('Conversation reset.') }

            return (
                <div className="mindflow-container">
                    <div style={{ marginBottom: 12 }}>
                        <h3 style={{ margin: 0 }}>Mind Flow</h3>
                        <p className="text-muted">A calm place to share — I'll ask a few gentle questions and help find resources if needed.</p>
                    </div>

                    <div className="card" style={{ padding: 12 }}>
                        <form onSubmit={handleInlineFormSubmit} aria-label="Inline mood logger" style={{ display: 'grid', gap: 8 }}>
                            <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                                <div style={{ fontWeight: 800 }}>Quick check-in</div>
                                <div style={{ display: 'flex', gap: 8 }}>
                                    {[5,4,3,2,1].map(v => (
                                        <label key={v} className={"control-btn"} style={{ padding: '6px 10px', borderRadius: 8 }}>
                                            <input type="radio" name="mf-mood" value={v} style={{ display: 'none' }} />{v}
                                        </label>
                                    ))}
                                </div>
                            </div>
                            <input id="mf-tags" placeholder="Tags (comma separated)" aria-label="Tags" />
                            <textarea id="mf-notes" rows={2} placeholder="Optional note" aria-label="Notes" />
                            <div style={{ display: 'flex', gap: 8 }}>
                                <button type="submit" className="primary-btn">Save check-in</button>
                                <button type="button" onClick={() => { document.getElementById('mf-notes').value=''; document.getElementById('mf-tags').value=''; }}>Clear</button>
                            </div>
                        </form>

                        <div style={{ marginTop: 12 }}>
                            <div style={{ fontSize: 13, color: '#666', marginBottom: 6 }}>Start quickly</div>
                            <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                                {startOptions.map((opt,i) => (
                                    <button key={i} onClick={() => { lastStarterRef.current = opt.label; setCurrentStarter(opt.label); setInput(opt.text); setTimeout(()=>handleSendText(opt.text), 200) }} className="control-btn">{opt.label}</button>
                                ))}
                            </div>
                        </div>

                        <div ref={scrollRef} style={{ maxHeight: 300, overflowY: 'auto', marginTop: 12 }}>
                            {messages.length === 0 && <div style={{ textAlign: 'center', color: '#888', padding: '30px 0' }}>Type a message to begin — I’ll ask a few short questions to help.</div>}
                            {messages.map((m, idx) => (
                                <div key={idx} style={{ marginBottom: 10, textAlign: m.type==='user'?'right':'left' }}>
                                    <div className={"chat-bubble " + (m.type==='user'?'user':'bot')}>{m.text}</div>
                                </div>
                            ))}
                        </div>

                        <div style={{ display: 'flex', gap: 8, marginTop: 8 }}>
                            <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter' && handleSendText()} placeholder="Type your message here..." />
                            <button onClick={()=>handleSendText()} className="primary-btn">Send</button>
                        </div>

                        <div style={{ marginTop: 10, display: 'flex', gap: 8 }}>
                            <button onClick={clearLogs} className="secondary-btn">Clear logs</button>
                            <button onClick={resetConversation} className="control-btn">Reset chat</button>
                        </div>
                    </div>
                </div>
            )
        }

        ReactDOM.createRoot(document.getElementById('mind-flow-root')).render(<MindFlow />)
        </script>
    </body>
</html>
</html>
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Mind Flow — MoodHouse</title>
        <link rel="stylesheet" href="style.css" />
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
        <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>window.MF_PUBLIC_FEED = true; /* feature flag: public read-only feed */</script>
    <script defer src="public-feed.js"></script>
    <script defer src="sentimentAdapter.js"></script>
    <script defer src="riskClassifier.js"></script>
    </head>
    <body>
    <div id="legacy-app" data-legacy>
        <a class="skip-link" href="#mind-flow-root">Skip to main content</a>

        <header class="topbar" role="banner" aria-label="Top navigation">
            <div class="topbar-left">
                <div class="avatar" aria-hidden="true">MH</div>
                <div class="brand">
                    <strong class="brand-title">MoodHouse</strong>
                    <span class="brand-sub">Daily Check-in</span>
                </div>
            </div>
            <nav class="top-actions" aria-label="Profile actions">
                <button id="toggle-soft-btn" class="control-btn" aria-pressed="false" title="Toggle softer colors">Softer colors</button>
                <button class="icon-btn" aria-label="Settings">⚙️</button>
            </nav>
        </header>

        <div class="site-hero">
            <h1>Mind Flow</h1>
            <p>A private, accessible place to track how you feel and find guidance when needed.</p>
        </div>

        <main id="mood-app-container">

            <!-- Mind Flow replaces the old 'How are you feeling today?' logger -->
            <section id="mind-flow" aria-labelledby="mind-flow-title" class="card">
                <h2 id="mind-flow-title">Mind Flow</h2>
                <div id="mind-flow-root"></div>
            </section>

                <!-- Minimal hidden legacy logger (kept for script.js compatibility) -->
                <section id="mood-logger" class="sr-only" aria-hidden="true">
                    <h2 id="logger-title" class="sr-only">How are you feeling today?</h2>
                    <form id="mood-log-form">
                        <p class="date-display">Today's Date: <time id="current-date" datetime=""></time></p>
                        <fieldset class="mood-scale" role="radiogroup" aria-label="Select your current mood">
                            <legend class="sr-only">Mood Selection</legend>
                            <!-- single radio so legacy scripts and self-test can tick a value -->
                            <input type="radio" id="mood-vgood" name="mood" value="5">
                            <label for="mood-vgood">Very Good</label>
                        </fieldset>

                        <div class="input-group">
                            <label for="activity-tags" class="sr-only">Activity tags</label>
                            <input type="text" id="activity-tags" placeholder="Tags (comma separated)" />
                        </div>

                        <div class="input-group">
                            <label for="mood-notes" class="sr-only">Notes</label>
                            <textarea id="mood-notes" rows="2"></textarea>
                        </div>

                        <button type="submit" id="log-mood-btn">Log My Mood</button>
                    </form>
                </section>

            <aside id="resource-banner" class="alert-banner hidden" role="alert" aria-live="polite">
                <p>It looks like you've logged a challenging mood pattern. <strong>Immediate, affordable support is available.</strong></p>
                <a href="resources.html" class="secondary-btn">Access Guided Resources</a>
            </aside>

            <section id="mood-history" aria-labelledby="history-title" class="card">
                <div class="history-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                    <h2 id="history-title" style="margin:0">Your Mood Trends</h2>
                    <div>
                        <button id="toggle-history-btn" class="control-btn" aria-expanded="true" aria-controls="mood-chart-container log-list">Collapse</button>
                    </div>
                </div>

                <div class="filter-controls">
                    <button id="view-7-day" class="control-btn active" aria-controls="mood-chart">7-Day Trend</button>
                    <button id="view-30-day" class="control-btn" aria-controls="mood-chart">Monthly Summary</button>
                    <button id="find-support-btn" class="control-btn" type="button">Find Nearby Support</button>
                </div>

                <div id="mood-chart-container" class="chart-container">
                    <canvas id="mood-chart" role="img" aria-label="Interactive line graph displaying your daily average mood score." aria-describedby="chart-desc"></canvas>
                    <p id="chart-desc" class="sr-only">This chart shows the recent trend of your daily mood scores. Higher values represent better mood.</p>
                    <div id="no-data" class="no-data" aria-hidden="true">No mood logs yet. Your entries will appear here.</div>
                </div>

                <div id="log-list" class="card" aria-live="polite">
                    <h3>Your Logs</h3>
                    <div id="logs-container">
                        <p class="text-muted">No logs yet. Your entries will appear here.</p>
                    </div>
                </div>
            </section>

            <section id="therapists" aria-labelledby="therapists-title" class="card">
                <h2 id="therapists-title" style="margin-top:0">Available Therapists</h2>
                <p class="text-muted" style="margin-top:4px; font-size:0.9rem">Browse supportive professionals (sample/demo data). Filter by specialty or modality.</p>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:12px 0 6px;">
                    <input id="therapist-filter" type="search" placeholder="Filter (e.g. anxiety, cbt)" aria-label="Filter therapists" style="flex:1; padding:8px 10px; border-radius:8px; border:1px solid var(--glass-border);" />
                    <button type="button" id="therapist-clear" class="control-btn">Clear</button>
                </div>
                <div id="therapist-list" class="therapist-list" aria-live="polite"></div>
                <div id="therapist-loading" class="therapist-list" aria-hidden="true" style="display:none;">
                    <div class="therapist-card therapist-skeleton"><div class="sk-lines"><div class="sk-line w60"></div><div class="sk-line w40"></div><div class="sk-line w80"></div></div></div>
                    <div class="therapist-card therapist-skeleton"><div class="sk-lines"><div class="sk-line w80"></div><div class="sk-line w60"></div><div class="sk-line w40"></div></div></div>
                    <div class="therapist-card therapist-skeleton"><div class="sk-lines"><div class="sk-line w60"></div><div class="sk-line w40"></div><div class="sk-line w80"></div></div></div>
                </div>
            </section>

        </main>

        <footer class="page-footer" role="contentinfo">
            <p>Private &middot; For self-reflection and to help connect to resources when needed.</p>
        </footer>

        <div id="toast-area" aria-live="polite" aria-atomic="true"></div>
        <div id="consent-banner" class="consent-banner hidden" role="dialog" aria-modal="true" aria-labelledby="consent-title">
            <div class="cb-inner">
                <h3 id="consent-title" style="margin:0 0 6px; font-size:1rem;">Session & Privacy</h3>
                <p style="margin:0 0 10px; font-size:0.8rem; line-height:1.3">Mind Flow is a supportive assistant, not a clinical tool. Messages stay in your browser unless you opt-in to external analysis for improved emotional detection.</p>
                <form id="consent-form" style="display:flex; flex-direction:column; gap:8px;">
                    <label style="display:flex; gap:6px; align-items:flex-start; font-size:0.78rem;">
                        <input type="checkbox" id="consent-nlp" />
                        <span>Allow external sentiment analysis API (may send anonymized text).</span>
                    </label>
                    <label style="display:flex; gap:6px; align-items:flex-start; font-size:0.78rem;">
                        <input type="checkbox" id="consent-retain" />
                        <span>Retain session transcript locally for next visit.</span>
                    </label>
                    <div style="display:flex; gap:8px; margin-top:6px;">
                        <button type="submit" class="primary-btn" style="padding:8px 14px; font-size:0.75rem;">Accept & Continue</button>
                        <button type="button" id="consent-decline" class="control-btn" style="padding:8px 14px; font-size:0.75rem;">Decline</button>
                    </div>
                </form>
            </div>
        </div>

        <script src="script.js"></script>
                                <script>
                // Hide chart area until at least one log exists
                (function(){
                    function toggleChartVisibility(){
                        try{
                            const raw = localStorage.getItem('accessibleMoodHistory');
                            const arr = raw? JSON.parse(raw): [];
                            const container = document.getElementById('mood-chart-container');
                            if(!container) return;
                                            if(!arr.length){
                                                container.classList.add('chart-hidden');
                                            } else {
                                                // trigger animated reveal only once
                                                if(container.classList.contains('chart-hidden')){
                                                    requestAnimationFrame(()=>{
                                                        container.classList.remove('chart-hidden');
                                                        container.classList.add('chart-revealed');
                                                    });
                                                }
                                            }
                        }catch(e){}
                    }
                    window.addEventListener('moodHistoryUpdated', toggleChartVisibility);
                    window.addEventListener('DOMContentLoaded', toggleChartVisibility);
                })();

                                // Therapist directory fetch with localStorage cache + API fallback
                                (function(){
                                    const LS_KEY='therapistDirectoryCacheV1';
                                    let data=[];
                                    let apiTried=false;
                                    function render(list){
                                        const host=document.getElementById('therapist-list'); if(!host) return;
                                        host.innerHTML='';
                                        if(!list.length){ host.innerHTML='<p class="text-muted">No matches.</p>'; return; }
                                        list.forEach(t=>{
                                            const card=document.createElement('div'); card.className='therapist-card';
                                            card.innerHTML=`<div class='t-head'><strong>${t.name}</strong> <span class='t-mod'>${t.modality}</span></div>
                                                <div class='t-focus'>${(t.focus||[]).map(f=>`<span>#${f}</span>`).join(' ')}</div>
                                                <div class='t-meta'><span>${t.slots||'Schedule TBD'}</span> · <span>${t.remote?'Remote / In-person':'In-person only'}</span></div>
                                                <button class='primary-btn t-contact' type='button'>Contact</button>`;
                                            card.querySelector('.t-contact').addEventListener('click',()=>{ alert('Contact flow demo: '+t.name); });
                                            host.appendChild(card);
                                        });
                                    }
                                    function filter(){
                                        const q=(document.getElementById('therapist-filter')?.value||'').trim().toLowerCase();
                                        if(!q) return render(data);
                                        const parts=q.split(/\s+/).filter(Boolean);
                                        render(data.filter(t => parts.every(p => t.name.toLowerCase().includes(p) || (t.focus||[]).some(f=>f.includes(p)) || (t.modality||'').toLowerCase().includes(p))));
                                    }
                                    function showLoading(on){ const sk=document.getElementById('therapist-loading'); if(sk){ sk.style.display=on?'grid':'none'; sk.setAttribute('aria-hidden', on?'false':'true'); } }
                                    async function load(){
                                        const cached=localStorage.getItem(LS_KEY);
                                        if(cached){ try { data=JSON.parse(cached); } catch(e){} }
                                        render(data);
                                        showLoading(true);
                                        try {
                                            // First attempt API endpoint
                                            if(!apiTried){
                                                apiTried=true;
                                                try {
                                                    const apiRes=await fetch('/api/therapists');
                                                    if(apiRes.ok){ const apiData=await apiRes.json(); if(Array.isArray(apiData) && apiData.length){ data=apiData; localStorage.setItem(LS_KEY, JSON.stringify(apiData)); filter(); showLoading(false); return; } }
                                                } catch(e){}
                                            }
                                            const res=await fetch('therapists.json',{cache:'no-cache'});
                                            if(res.ok){ const fresh= await res.json(); if(Array.isArray(fresh)){ data=fresh; localStorage.setItem(LS_KEY, JSON.stringify(fresh)); filter(); } }
                                        } catch(e){}
                                        showLoading(false);
                                    }
                                    window.addEventListener('DOMContentLoaded',()=>{
                                        load();
                                        const inp=document.getElementById('therapist-filter'); if(inp) inp.addEventListener('input', filter);
                                        const clr=document.getElementById('therapist-clear'); if(clr) clr.addEventListener('click', ()=>{ if(inp){ inp.value=''; filter(); } });
                                    });
                                })();
                </script>

        <!-- Mind Flow React component (Babel) -->
        <script type="text/babel">
        // Mind Flow component — single copy
        const STORAGE_KEY = 'accessibleMoodHistory';
        function safeParse(json){ try { return JSON.parse(json) } catch(e) { return null } }
        function nowDate(){ return new Date().toISOString().slice(0,10) }

        function MindFlow(){
            const [logs, setLogs] = React.useState(() => safeParse(localStorage.getItem(STORAGE_KEY)) || [])
            const [input, setInput] = React.useState('')
            const [messages, setMessages] = React.useState([])
            const [isTyping, setIsTyping] = React.useState(false)
            const [currentStarter, setCurrentStarter] = React.useState(null)
            const scrollRef = React.useRef(null)
            const lastStarterRef = React.useRef(null)
            const [selectedMood, setSelectedMood] = React.useState(null)
            const [tagInput, setTagInput] = React.useState(() => localStorage.getItem('mf_tag_draft') || '')
            const [tags, setTags] = React.useState([])
            const [lastInsightSig, setLastInsightSig] = React.useState(null)
            const [insightsEnabled, setInsightsEnabled] = React.useState(() => localStorage.getItem('mf_insights_enabled') !== 'false')
            const [riskMeta, setRiskMeta] = React.useState({ level:'normal', score:0 })
            const [consent, setConsent] = React.useState({ nlp:false, retain:false, ready:false })
            const sessionIdRef = React.useRef(localStorage.getItem('mf_session_id') || (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)))
            React.useEffect(()=>{ localStorage.setItem('mf_session_id', sessionIdRef.current) }, [])
            const [sessionPhase, setSessionPhase] = React.useState('init') // init | active | ending | ended
            const [actions, setActions] = React.useState([]) // [{label, handler}]
            const [lastSuggestion, setLastSuggestion] = React.useState(null)
            const [escalation, setEscalation] = React.useState({ offered:false, accepted:false })

            const startOptions = [
                { label: 'Just checking in', text: "Just checking in — wondering how I'm doing today." },
                { label: 'Feeling stressed', text: "I've been feeling stressed and overwhelmed." },
                { label: 'Feeling low', text: "Lately I've been feeling a bit low and unmotivated." },
                { label: 'Need urgent help', text: "I might need urgent help — I'm worried about my safety." }
            ]

            function persistLogs(next){
                localStorage.setItem(STORAGE_KEY, JSON.stringify(next))
                setLogs(next)
                try{ if (typeof renderMoodChart === 'function') renderMoodChart(next) } catch(e){}
                try{ if (typeof renderLogsList === 'function') renderLogsList(next) } catch(e){}
                try{ window.dispatchEvent(new CustomEvent('moodHistoryUpdated',{detail: next})) } catch(e){}
                try{ if (typeof showToast === 'function') showToast('Saved to Your Logs') } catch(e){}
            }

            React.useEffect(()=>{
                // Initial lightweight greeting (full intro after consent)
                pushBot("Hi — I'm Mind Flow, an AI support assistant (not a clinician). I'll wait for you to review privacy before we begin.")
                try{ if (typeof renderMoodChart === 'function') renderMoodChart(logs) } catch(e){}
                try{ if (typeof renderLogsList === 'function') renderLogsList(logs) } catch(e){}

                function onMoodUpdate(e){
                    const next = (e && e.detail) ? e.detail : safeParse(localStorage.getItem(STORAGE_KEY)) || []
                    setLogs(next)
                    try{ if (typeof renderMoodChart === 'function') renderMoodChart(next) } catch(e){}
                    try{ if (typeof renderLogsList === 'function') renderLogsList(next) } catch(e){}
                }
                window.addEventListener('moodHistoryUpdated', onMoodUpdate)
                window.addEventListener('storage', onMoodUpdate)
                window.addEventListener('restoreConversation', (e)=>{
                    const entry = e && e.detail ? e.detail : null
                    if (entry && entry.conversation) setMessages(entry.conversation)
                })
                return ()=>{
                    window.removeEventListener('moodHistoryUpdated', onMoodUpdate)
                    window.removeEventListener('storage', onMoodUpdate)
                }
            // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [])

            React.useEffect(()=>{ if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight }, [messages, isTyping, actions])

            // Consent banner mount
            React.useEffect(()=>{
                const stored = safeParse(localStorage.getItem('mf_consent'));
                if(stored){
                    setConsent({...stored, ready:true});
                    // Start session automatically once consent object exists (accepted or declined external NLP)
                    setSessionPhase('active');
                    pushIntro(stored);
                    return;
                }
                const cb = document.getElementById('consent-banner'); if(cb) cb.classList.remove('hidden');
                const form = document.getElementById('consent-form');
                const decline = document.getElementById('consent-decline');
                function finalize(accepted){
                    const nlp = accepted && document.getElementById('consent-nlp').checked;
                    const retain = accepted && document.getElementById('consent-retain').checked;
                    const obj = { accepted, nlp, retain, ts: Date.now() };
                    localStorage.setItem('mf_consent', JSON.stringify(obj));
                    setConsent({...obj, ready:true});
                    if(cb) cb.classList.add('hidden');
                    if(!retain){ localStorage.removeItem('accessibleMoodHistory'); }
                    setSessionPhase('active');
                    pushIntro(obj);
                }
                form && form.addEventListener('submit', e=>{ e.preventDefault(); finalize(true); });
                decline && decline.addEventListener('click', ()=>finalize(false));
                return ()=>{
                    form && form.removeEventListener('submit', ()=>{});
                    decline && decline.removeEventListener('click', ()=>{});
                }
            },[])

            function pushIntro(cons){
                const privacyLine = cons.accepted ? (cons.nlp? 'If you enable external analysis, anonymized text may be processed.' : 'We will keep everything local in your browser.') : 'All processing will remain local and no external analysis will be used.';
                pushBot("Thanks for setting preferences. I'm here to listen and support. You can tell me how you're feeling or choose a starter. You can type 'end' anytime to wrap up.")
                pushBot(privacyLine)
            }

            function pushUser(text){ setMessages(prev=>[...prev,{type:'user', text}]) }
            function pushBot(text, meta){ setMessages(prev=>[...prev,{type:'bot', text, meta}]) }

            function addActions(list){ setActions(list.map(a=>({...a,id:crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2)}))) }
            function clearActions(){ setActions([]) }

            const crisisPatterns = ['kill myself','end my life','suicide','hurt myself','cutting','no reason to live','i might harm']
            function detectCrisis(text){ const lt=(text||'').toLowerCase(); return crisisPatterns.some(p => lt.includes(p)) }

            function addLog(mood, note, meta){
                const entry = { date: nowDate(), mood: Number(mood), tags: (meta && meta.tags) || [], notes: note || '' }
                if (meta && meta.conversation) entry.conversation = meta.conversation
                if (meta && meta.starter) entry.starter = meta.starter
                const existing = logs.findIndex(l => l.date === entry.date)
                const next = existing !== -1 ? logs.slice().map((v,i)=> i===existing?entry:v) : [...logs, entry]
                persistLogs(next)
                analyzeInsights(next)
            }

            function handleSendText(raw){
                const text = raw || input
                if (!text || !text.trim()) return
                if(sessionPhase==='ended') { pushBot('Session has ended. Start a new session to continue.'); return }
                if(sessionPhase==='init'){ pushBot('Please review the privacy panel and accept or decline to begin.'); return }
                pushUser(text)
                setInput('')
                setIsTyping(true)
                // Session end detection
                const lt = text.toLowerCase();
                if(sessionPhase==='active' && /(end session|end|finish|stop|goodbye|bye)/.test(lt)) { setTimeout(()=>{ endSession(); }, 400); return }
                // Decline / skip handling for last suggestion
                if(lastSuggestion && /(no|not now|skip|maybe later|another time)/.test(lt)) {
                    setLastSuggestion(null);
                    clearActions();
                    setTimeout(()=>{ setIsTyping(false); pushBot('Absolutely okay — I will just listen. Share anything you like.'); }, 400);
                    return;
                }
                const moodMatch = (text||'').match(/mood\s*[:\-]?\s*([1-5])(?:\s*[-–—]\s*(.+))?/i)
                if (moodMatch){ addLog(Number(moodMatch[1]), moodMatch[2] ? moodMatch[2].trim() : '', { conversation: messages.slice(), starter: lastStarterRef.current }); setIsTyping(false); pushBot('Saved to Your Logs.'); return }
                // Extract hashtags from message and merge into editable tag list (without auto-saving)
                const found=(text.match(/#[\w-]{2,24}/g)||[]).map(t=>t.slice(1).toLowerCase());
                if(found.length){ setTags(prev=>Array.from(new Set([...prev, ...found])).slice(0,12)); }
                setTimeout(async ()=>{
                    // Consent-gated sentiment adapter (async) then risk classify
                    let extScore = null;
                    if(consent.ready && consent.accepted && consent.nlp && typeof sentimentAdapter !== 'undefined') {
                        try {
                            const res = await sentimentAdapter.analyze(text, { session: sessionIdRef.current });
                            if(res && typeof res.score === 'number') extScore = res.score;
                        } catch(err){ /* swallow */ }
                    }
                    setIsTyping(false)
                    try {
                        if (typeof classifyRisk === 'function') {
                            const meta = classifyRisk(text, messages, extScore);
                            setRiskMeta(meta);
                            if(meta.level==='high') { offerHighRiskSupport(meta); lastStarterRef.current=null; return }
                            if(meta.level==='moderate') { maybeOfferGrounding(); lastStarterRef.current=null; return }
                        }
                    } catch(e){}
                    if (detectCrisis(text)){ pushBot("I'm worried by what you shared. If you're in immediate danger, call emergency services."); return }
                    const intent = detectIntent(text);
                    routeIntent(intent, text);
                    lastStarterRef.current = null
                }, 600)
            }

            function detectIntent(text){
                const t = (text||'').toLowerCase();
                if(/anxi|panic|overwhelm/.test(t)) return 'anxiety';
                if(/sleep|insomnia|tired/.test(t)) return 'sleep';
                if(/lonely|alone|isolat/.test(t)) return 'lonely';
                if(/no motivation|unmotivated|cant focus|can't focus/.test(t)) return 'motivation';
                if(/thank|thanks|appreciate/.test(t)) return 'gratitude';
                return 'general';
            }

            function routeIntent(intent, raw){
                switch(intent){
                    case 'anxiety':
                        pushBot('That sounds stressful. Would a brief grounding or breathing exercise be helpful?');
                        setLastSuggestion('grounding');
                        addActions([
                            { label:'Try grounding', handler: startGrounding },
                            { label:'Show breathing', handler: startBreathing },
                            { label:'Just listen', handler: ()=>{ pushBot('Okay, I am here. Share anything that feels important.'); clearActions(); } }
                        ]);
                        break;
                    case 'sleep':
                        pushBot('Sleep struggles can be hard. Sometimes a gentle wind-down routine helps. Want a quick tip?');
                        setLastSuggestion('sleep-tip');
                        addActions([
                            { label:'Give a tip', handler: ()=>{ pushBot('Try a 5-minute screen-free break and a slow exhale pattern (4 in, 6 out) to cue rest.'); clearActions(); } },
                            { label:'Not now', handler: ()=>{ pushBot('No problem. We can revisit later.'); clearActions(); } }
                        ]);
                        break;
                    case 'lonely':
                        pushBot('Feeling lonely is tough. Would exploring supportive community options help?');
                        setLastSuggestion('community');
                        addActions([
                            { label:'Suggest resources', handler: ()=>{ pushBot('Consider peer support lines or moderated online communities focused on shared interests.'); clearActions(); } },
                            { label:'Skip', handler: ()=>{ pushBot('Alright. I can simply listen.'); clearActions(); } }
                        ]);
                        break;
                    case 'motivation':
                        pushBot('Motivation dips happen. Want a tiny action planning prompt?');
                        setLastSuggestion('action-plan');
                        addActions([
                            { label:'Yes plan', handler: ()=>{ pushBot('Pick one task under 5 min. After finishing, send me "done" and we can reflect.'); clearActions(); } },
                            { label:'Skip', handler: ()=>{ pushBot('Understood. Take your time.'); clearActions(); } }
                        ]);
                        break;
                    case 'gratitude':
                        pushBot('I appreciate you too. Anything else you’d like to explore or should we begin wrapping up?');
                        break;
                    default:
                        pushBot('Thanks for sharing — can you tell me how long you\'ve felt like this?')
                }
            }

            function maybeOfferGrounding(){
                if(lastSuggestion==='grounding') return;
                setLastSuggestion('grounding');
                pushBot('That sounds really tough. Would a short grounding exercise help?');
                addActions([
                    { label:'Yes grounding', handler: startGrounding },
                    { label:'Breathing', handler: startBreathing },
                    { label:'No thanks', handler: ()=>{ pushBot('Okay — I will just stay with you in this. Share anything you like.'); clearActions(); } }
                ]);
            }

            function offerHighRiskSupport(meta){
                if(escalation.offered) { pushBot('Please choose: hotline info, grounding, or just talk.'); return }
                setEscalation(prev=>({...prev, offered:true}));
                pushBot("I sense this may be urgent. You're not alone. I can show hotline info, guide grounding, or just listen. What would you like?");
                addActions([
                    { label:'Hotline info', handler: showHotlines },
                    { label:'Grounding', handler: startGrounding },
                    { label:'Just listen', handler: ()=>{ pushBot('I will stay with you here. Type anything that comes up.'); clearActions(); } }
                ]);
            }

            function showHotlines(){
                clearActions();
                const region = localStorage.getItem('hotlineRegion')||'us';
                const map={
                    us:'988 (Suicide & Crisis Lifeline) — call or text 988',
                    uk:'Samaritans: 116 123',
                    ca:'988 (Talk Suicide Canada)',
                    au:'Lifeline: 13 11 14'
                };
                pushBot(`Here are hotline details (${region.toUpperCase()}): ${map[region]||map.us}. If you are in immediate danger, contact local emergency services.`);
                setEscalation(prev=>({...prev, accepted:true}));
            }

            function startGrounding(){
                clearActions();
                pushBot('Let’s try a 5-4-3-2-1 grounding. Ready? (You can type stop anytime)');
                setTimeout(()=>pushBot('Name 5 things you can see.'), 800);
                setTimeout(()=>pushBot('Great. Now 4 things you can touch.'), 5000);
                setTimeout(()=>pushBot('Now 3 things you can hear.'), 9500);
                setTimeout(()=>pushBot('Next 2 things you can smell or like the scent of.'), 14000);
                setTimeout(()=>pushBot('Finally 1 thing you appreciate about yourself right now.'), 18500);
                setTimeout(()=>{ pushBot('How do you feel now? A tiny shift counts.'); }, 24000);
            }

            function startBreathing(){
                clearActions();
                pushBot('Let’s do a brief paced breathing: Inhale 4, hold 2, exhale 6. I’ll count a few cycles.');
                let cycle=0;
                function step(){
                    if(cycle>=3){ pushBot('Nice work. Notice any small change in tension?'); return }
                    cycle++;
                    pushBot(`Cycle ${cycle}: Inhale (4) ... Hold (2) ... Exhale (6).`);
                    setTimeout(step, 6000);
                }
                setTimeout(step, 800);
            }

            function endSession(){
                const userMsgs = messages.filter(m=>m.type==='user').length;
                const today = logs.find(l=>l.date===nowDate());
                pushBot(`Session summary: ${userMsgs} messages shared${today? ', mood saved today at level '+today.mood:''}. Remember this space is not clinical care but a reflective aid.`);
                pushBot('You can clear this conversation or start fresh. Take care of yourself.');
                setSessionPhase('ended');
                addActions([
                    { label:'Start new session', handler: ()=>{ setMessages([]); setSessionPhase('active'); pushIntro(consent); clearActions(); } },
                    { label:'Clear & close', handler: ()=>{ setMessages([]); setSessionPhase('ended'); clearActions(); } }
                ]);
            }

            function addTagFromInput(){
                const val=tagInput.trim().toLowerCase().replace(/^#/,'');
                if(!val) return;
                setTags(prev => prev.includes(val) ? prev : [...prev, val].slice(0,12));
                setTagInput('');
                localStorage.removeItem('mf_tag_draft');
            }
            function removeTag(t){ setTags(prev => prev.filter(x=>x!==t)); }

            function saveMoodEntry(){
                if(!selectedMood) return;
                // include new hashtags from current input if any
                const inlineTags=(input.match(/#[\w-]{2,24}/g)||[]).map(t=>t.slice(1).toLowerCase());
                const allTags=Array.from(new Set([...tags, ...inlineTags]));
                addLog(selectedMood, input.trim(), { conversation: messages.slice(), starter: currentStarter, tags: allTags });
                setInput(''); setSelectedMood(null); setTags([]); setTagInput(''); pushBot('Mood saved.');
            }

            function analyzeInsights(allLogs){
                if(!insightsEnabled) return; // respect user preference
                if(!allLogs.length) return;
                const recent = allLogs.slice(-7);
                const lows = recent.filter(l=>l.mood <=2).length;
                const highs = recent.filter(l=>l.mood >=4).length;
                const avg = (recent.reduce((a,b)=>a+(b.mood||0),0)/recent.length).toFixed(2);
                const sig = `${recent.length}|${lows}|${highs}|${avg}`;
                if(sig===lastInsightSig) return;
                // Choose one insight message based on pattern priority
                let msg=null;
                if(lows >=3) msg = 'Noticing several low moods this week. Would a small grounding activity help?';
                else if(highs >=3) msg = 'Nice streak of higher moods recently—maybe journal what contributed?';
                else if(avg && recent.length>=5) msg = `Your 7-day average mood is ${avg}. Want to set a gentle goal?`;
                if(msg){ pushBot(msg,{insight:true}); setLastInsightSig(sig); }
            }

            function handleInlineFormSubmit(e){
                e && e.preventDefault && e.preventDefault()
                const mood = document.querySelector('input[name="mf-mood"]:checked')
                const tags = (document.getElementById('mf-tags') && document.getElementById('mf-tags').value) || ''
                const notes = (document.getElementById('mf-notes') && document.getElementById('mf-notes').value) || ''
                if (!mood){ try{ if (typeof showToast === 'function') showToast('Select a mood before saving', 'warn') } catch(e){}; return }
                addLog(Number(mood.value), notes, { conversation: messages.slice(), starter: currentStarter, tags: tags.split(',').map(t=>t.trim()).filter(Boolean) })
                try{ if (typeof showToast === 'function') showToast('Check-in saved', 'success') } catch(e){}
            }

            function clearLogs(){ if (!confirm('Clear all saved mood logs?')) return; persistLogs([]); pushBot('Your saved mood logs have been cleared.') }
            function resetConversation(){ if (!confirm('Reset conversation?')) return; try { const snapshot = { date: nowDate(), mood: null, notes: '', conversation: messages.slice() }; persistLogs([...logs, snapshot]) } catch (e){}; setMessages([]); pushBot('Conversation reset.') }

            return (
                <div className="mindflow-container">
                    <div style={{ marginBottom: 12 }}>
                        <h3 style={{ margin: 0 }}>Mind Flow</h3>
                        <p className="text-muted">A calm place to share — I'll ask a few gentle questions and help find resources if needed.</p>
                    </div>

                    <div className="card" style={{ padding: 12 }}>
                        <div style={{ marginTop: 4 }}>
                            <div style={{ fontSize: 13, color: '#666', marginBottom: 6 }}>Start quickly</div>
                            <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                                {startOptions.map((opt,i) => (
                                    <button key={i} onClick={() => { lastStarterRef.current = opt.label; setCurrentStarter(opt.label); setInput(opt.text); setTimeout(()=>handleSendText(opt.text), 200) }} className="control-btn">{opt.label}</button>
                                ))}
                            </div>
                        </div>
                        <div style={{ background:'rgba(0,0,0,0.04)', padding:'8px 10px', borderRadius:8, marginTop:10, fontSize:11, lineHeight:1.4 }}>
                            This assistant is not a substitute for professional diagnosis or emergency services. Risk level: <strong>{riskMeta.level}</strong>{riskMeta.level!=='normal' ? ` (sentiment ${riskMeta.score})` : ''}.
                        </div>

                        <div style={{ marginTop: 16 }}>
                            <strong style={{ fontSize: 13 }}>Select a mood (optional)</strong>
                            <div className="mf-mood-picker" role="group" aria-label="Select mood" style={{ display:'flex', gap:8, marginTop:8, flexWrap:'wrap' }}>
                                {[5,4,3,2,1].map(v => (
                                    <button type="button" key={v} className={"mood-chip" + (selectedMood===v?" active":"")} onClick={()=>setSelectedMood(v)} aria-pressed={selectedMood===v}>{v}</button>
                                ))}
                                <button type="button" className="mood-chip clear" onClick={()=>setSelectedMood(null)} aria-pressed={selectedMood===null}>Clear</button>
                            </div>
                            <div className="tag-editor" style={{ marginTop:12 }}>
                                <label style={{ fontSize:12, fontWeight:600, display:'block', marginBottom:4 }}>Tags</label>
                                <div style={{ display:'flex', gap:6, flexWrap:'wrap', marginBottom:6 }}>
                                    {tags.map(t => (
                                        <span key={t} className="tag-chip" style={{ display:'inline-flex', alignItems:'center', gap:4 }}>
                                            #{t}<button type="button" aria-label={`Remove tag ${t}`} onClick={()=>removeTag(t)} style={{ background:'transparent', border:'none', cursor:'pointer', fontSize:14, lineHeight:1 }}>✕</button>
                                        </span>
                                    ))}
                                            <input aria-label="Add tag" value={tagInput} onChange={e=>{ setTagInput(e.target.value); localStorage.setItem('mf_tag_draft', e.target.value); }} onKeyDown={e=>{ if(e.key==='Enter'){ e.preventDefault(); addTagFromInput(); } }} placeholder="Add tag" style={{ minWidth:90, padding:'4px 8px', border:'1px solid var(--glass-border)', borderRadius:8 }} />
                                    <button type="button" className="control-btn" style={{ padding:'4px 10px' }} onClick={addTagFromInput}>Add</button>
                                </div>
                                <div style={{ fontSize:11, opacity:.6 }}>Hashtags you type (e.g. #anxiety) are auto-suggested here before saving.</div>
                                <div style={{ marginTop:8, display:'flex', gap:8, flexWrap:'wrap', alignItems:'center' }}>
                                    <button
                                        type="button"
                                        className="control-btn insights-toggle"
                                        aria-pressed={insightsEnabled}
                                        aria-label={insightsEnabled? 'Disable automated mood insights' : 'Enable automated mood insights'}
                                        title={insightsEnabled? 'Disable automated mood insights' : 'Enable automated mood insights'}
                                        onClick={()=>{ const next=!insightsEnabled; setInsightsEnabled(next); localStorage.setItem('mf_insights_enabled', String(next)); if(!next){ showToast && showToast('Insights disabled','warn'); } else { showToast && showToast('Insights enabled'); analyzeInsights(logs);} }}>
                                        {insightsEnabled? 'Disable Insights' : 'Enable Insights'}
                                    </button>
                                    <span style={{ fontSize:10, opacity:.55, maxWidth:220 }}>Insights look for simple patterns only and are not a diagnosis.</span>
                                </div>
                            </div>
                        </div>

                        <div ref={scrollRef} style={{ maxHeight: 300, overflowY: 'auto', marginTop: 18 }}>
                            {messages.length === 0 && <div style={{ textAlign: 'center', color: '#888', padding: '30px 0' }}>Type a message to begin — I’ll ask a few short questions to help.</div>}
                            {messages.map((m, idx) => (
                                <div key={idx} style={{ marginBottom: 10, textAlign: m.type==='user'?'right':'left' }}>
                                    <div className={"chat-bubble " + (m.type==='user'?'user':'bot')}>{m.text}</div>
                                </div>
                            ))}
                            {actions.length>0 && <div style={{ margin:'10px 0 4px', display:'flex', flexWrap:'wrap', gap:8 }} aria-label="Suggested actions" role="group">
                                {actions.map(a=> <button key={a.id} className="control-btn" onClick={()=>{ a.handler(); }} style={{ padding:'6px 10px' }}>{a.label}</button>)}
                            </div>}
                        </div>
                        <div style={{ display: 'flex', flexDirection:'column', gap: 10, marginTop: 12 }}>
                            <div style={{ display:'flex', gap:8 }}>
                                <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter' && handleSendText()} placeholder={sessionPhase==='init' ? 'Review privacy to begin...' : (sessionPhase==='ended' ? 'Session ended — start new session?' : (selectedMood?`Optional note for mood ${selectedMood}`:'Type your message here...'))} disabled={sessionPhase==='init' || sessionPhase==='ended'} />
                                <button onClick={()=>handleSendText()} className="primary-btn">Send</button>
                            </div>
                            <div style={{ display:'flex', gap:8, flexWrap:'wrap' }}>
                                <button type="button" disabled={!selectedMood} className="control-btn" onClick={saveMoodEntry}>Save Mood</button>
                                <button onClick={clearLogs} className="secondary-btn">Clear logs</button>
                                <button onClick={resetConversation} className="control-btn">Reset chat</button>
                                <button type="button" className="control-btn" onClick={()=>endSession()}>End Session</button>
                            </div>
                        </div>
                    </div>
                </div>
            )
        }

        ReactDOM.createRoot(document.getElementById('mind-flow-root')).render(<MindFlow />)
        </script>
        </div><!-- /legacy-app -->
    </body>
</html>
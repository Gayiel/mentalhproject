<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Mind Flow — MoodHouse</title>
        <link rel="stylesheet" href="style.css" />
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
        <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>window.MF_PUBLIC_FEED = true; /* feature flag: public read-only feed */</script>
    <script defer src="public-feed.js"></script>
    </head>
    <body>
    <div id="legacy-app" data-legacy>
        <a class="skip-link" href="#mind-flow-root">Skip to main content</a>

        <header class="topbar" role="banner" aria-label="Top navigation">
            <div class="topbar-left">
                <div class="avatar" aria-hidden="true">MH</div>
                <div class="brand">
                    <strong class="brand-title">MoodHouse</strong>
                    <span class="brand-sub">Daily Check-in</span>
                </div>
            </div>
            <nav class="top-actions" aria-label="Profile actions">
                <button id="toggle-soft-btn" class="control-btn" aria-pressed="false" title="Toggle softer colors">Softer colors</button>
                <button class="icon-btn" aria-label="Settings">⚙️</button>
            </nav>
        </header>

        <div class="site-hero">
            <h1>Mind Flow</h1>
            <p>A private, accessible place to track how you feel and find guidance when needed.</p>
        </div>

        <main id="mood-app-container">

            <!-- Mind Flow replaces the old 'How are you feeling today?' logger -->
            <section id="mind-flow" aria-labelledby="mind-flow-title" class="card">
                <h2 id="mind-flow-title">Mind Flow</h2>
                <div id="mind-flow-root"></div>
            </section>

                <!-- Minimal hidden legacy logger (kept for script.js compatibility) -->
                <section id="mood-logger" class="sr-only" aria-hidden="true">
                    <h2 id="logger-title" class="sr-only">How are you feeling today?</h2>
                    <form id="mood-log-form">
                        <p class="date-display">Today's Date: <time id="current-date" datetime=""></time></p>
                        <fieldset class="mood-scale" role="radiogroup" aria-label="Select your current mood">
                            <legend class="sr-only">Mood Selection</legend>
                            <!-- single radio so legacy scripts and self-test can tick a value -->
                            <input type="radio" id="mood-vgood" name="mood" value="5">
                            <label for="mood-vgood">Very Good</label>
                        </fieldset>

                        <div class="input-group">
                            <label for="activity-tags" class="sr-only">Activity tags</label>
                            <input type="text" id="activity-tags" placeholder="Tags (comma separated)" />
                        </div>

                        <div class="input-group">
                            <label for="mood-notes" class="sr-only">Notes</label>
                            <textarea id="mood-notes" rows="2"></textarea>
                        </div>

                        <button type="submit" id="log-mood-btn">Log My Mood</button>
                    </form>
                </section>

            <aside id="resource-banner" class="alert-banner hidden" role="alert" aria-live="polite">
                <p>It looks like you've logged a challenging mood pattern. <strong>Immediate, affordable support is available.</strong></p>
                <a href="resources.html" class="secondary-btn">Access Guided Resources</a>
            </aside>

            <section id="mood-history" aria-labelledby="history-title" class="card">
                <div class="history-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                    <h2 id="history-title" style="margin:0">Your Mood Trends</h2>
                    <div>
                        <button id="toggle-history-btn" class="control-btn" aria-expanded="true" aria-controls="mood-chart-container log-list">Collapse</button>
                    </div>
                </div>

                <div class="filter-controls">
                    <button id="view-7-day" class="control-btn active" aria-controls="mood-chart">7-Day Trend</button>
                    <button id="view-30-day" class="control-btn" aria-controls="mood-chart">Monthly Summary</button>
                    <button id="find-support-btn" class="control-btn" type="button">Find Nearby Support</button>
                </div>

                <div id="mood-chart-container" class="chart-container">
                    <canvas id="mood-chart" role="img" aria-label="Interactive line graph displaying your daily average mood score." aria-describedby="chart-desc"></canvas>
                    <p id="chart-desc" class="sr-only">This chart shows the recent trend of your daily mood scores. Higher values represent better mood.</p>
                    <div id="no-data" class="no-data" aria-hidden="true">No mood logs yet. Your entries will appear here.</div>
                </div>

                <div id="log-list" class="card" aria-live="polite">
                    <h3>Your Logs</h3>
                    <div id="logs-container">
                        <p class="text-muted">No logs yet. Your entries will appear here.</p>
                    </div>
                </div>
            </section>

            <section id="therapists" aria-labelledby="therapists-title" class="card">
                <h2 id="therapists-title" style="margin-top:0">Available Therapists</h2>
                <p class="text-muted" style="margin-top:4px; font-size:0.9rem">Browse supportive professionals (sample/demo data). Filter by specialty or modality.</p>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:12px 0 6px;">
                    <input id="therapist-filter" type="search" placeholder="Filter (e.g. anxiety, cbt)" aria-label="Filter therapists" style="flex:1; padding:8px 10px; border-radius:8px; border:1px solid var(--glass-border);" />
                    <button type="button" id="therapist-clear" class="control-btn">Clear</button>
                </div>
                <div id="therapist-list" class="therapist-list" aria-live="polite"></div>
            </section>

        </main>

        <footer class="page-footer" role="contentinfo">
            <p>Private &middot; For self-reflection and to help connect to resources when needed.</p>
        </footer>

        <div id="toast-area" aria-live="polite" aria-atomic="true"></div>

        <script src="script.js"></script>
                <script>
                // Hide chart area until at least one log exists
                (function(){
                    function toggleChartVisibility(){
                        try{
                            const raw = localStorage.getItem('accessibleMoodHistory');
                            const arr = raw? JSON.parse(raw): [];
                            const container = document.getElementById('mood-chart-container');
                            if(!container) return;
                            if(!arr.length){ container.style.display='none'; }
                            else { container.style.display='block'; }
                        }catch(e){}
                    }
                    window.addEventListener('moodHistoryUpdated', toggleChartVisibility);
                    window.addEventListener('DOMContentLoaded', toggleChartVisibility);
                })();

                // Therapist directory demo (client-side static)
                (function(){
                    const data = [
                        { name:'Dr. Alicia Rivera', focus:['anxiety','cbt','stress'], slots:'Mon/Wed/Fri', modality:'CBT', remote:true },
                        { name:'James Okoro', focus:['depression','mindfulness','grief'], slots:'Tue/Thu', modality:'Mindfulness', remote:false },
                        { name:'Sofia Martins', focus:['burnout','career','anxiety'], slots:'Daily', modality:'Integrative', remote:true },
                        { name:'Liam Chen', focus:['trauma','emdr'], slots:'Wed/Fri', modality:'EMDR', remote:false },
                        { name:'Priya Singh', focus:['relationships','anxiety'], slots:'Weekends', modality:'Humanistic', remote:true }
                    ];
                    function render(list){
                        const host = document.getElementById('therapist-list'); if(!host) return;
                        host.innerHTML='';
                        if(!list.length){ host.innerHTML='<p class="text-muted">No matches.</p>'; return; }
                        list.forEach(t=>{
                            const card = document.createElement('div');
                            card.className='therapist-card';
                            card.innerHTML=`<div class='t-head'><strong>${t.name}</strong> <span class='t-mod'>${t.modality}</span></div>
                                <div class='t-focus'>${t.focus.map(f=>`<span>#${f}</span>`).join(' ')}</div>
                                <div class='t-meta'><span>${t.slots}</span> · <span>${t.remote?'Remote / In-person':'In-person only'}</span></div>
                                <button class='primary-btn t-contact' type='button'>Contact</button>`;
                            card.querySelector('.t-contact').addEventListener('click',()=>{
                                alert('Contact flow demo: '+t.name);
                            });
                            host.appendChild(card);
                        });
                    }
                    function filter(){
                        const q = (document.getElementById('therapist-filter')?.value || '').trim().toLowerCase();
                        if(!q) return render(data);
                        const parts = q.split(/\s+/).filter(Boolean);
                        const res = data.filter(t => parts.every(p => t.name.toLowerCase().includes(p) || t.focus.some(f=>f.includes(p)) || t.modality.toLowerCase().includes(p)));
                        render(res);
                    }
                    window.addEventListener('DOMContentLoaded',()=>{
                        render(data);
                        const inp=document.getElementById('therapist-filter');
                        if(inp) inp.addEventListener('input', ()=>{ filter(); });
                        const clr=document.getElementById('therapist-clear'); if(clr) clr.addEventListener('click', ()=>{ if(inp){ inp.value=''; filter(); } });
                    });
                })();
                </script>

        <!-- Mind Flow React component (Babel) -->
        <script type="text/babel">
        // Mind Flow component — single copy
        const STORAGE_KEY = 'accessibleMoodHistory';
        function safeParse(json){ try { return JSON.parse(json) } catch(e) { return null } }
        function nowDate(){ return new Date().toISOString().slice(0,10) }

        function MindFlow(){
            const [logs, setLogs] = React.useState(() => safeParse(localStorage.getItem(STORAGE_KEY)) || [])
            const [input, setInput] = React.useState('')
            const [messages, setMessages] = React.useState([])
            const [isTyping, setIsTyping] = React.useState(false)
            const [currentStarter, setCurrentStarter] = React.useState(null)
            const scrollRef = React.useRef(null)
            const lastStarterRef = React.useRef(null)
            const [selectedMood, setSelectedMood] = React.useState(null)

            const startOptions = [
                { label: 'Just checking in', text: "Just checking in — wondering how I'm doing today." },
                { label: 'Feeling stressed', text: "I've been feeling stressed and overwhelmed." },
                { label: 'Feeling low', text: "Lately I've been feeling a bit low and unmotivated." },
                { label: 'Need urgent help', text: "I might need urgent help — I'm worried about my safety." }
            ]

            function persistLogs(next){
                localStorage.setItem(STORAGE_KEY, JSON.stringify(next))
                setLogs(next)
                try{ if (typeof renderMoodChart === 'function') renderMoodChart(next) } catch(e){}
                try{ if (typeof renderLogsList === 'function') renderLogsList(next) } catch(e){}
                try{ window.dispatchEvent(new CustomEvent('moodHistoryUpdated',{detail: next})) } catch(e){}
                try{ if (typeof showToast === 'function') showToast('Saved to Your Logs') } catch(e){}
            }

            React.useEffect(()=>{
                pushBot("Hi — I'm Mind Flow. How can I help you today? You can try one of the quick starters below.")
                try{ if (typeof renderMoodChart === 'function') renderMoodChart(logs) } catch(e){}
                try{ if (typeof renderLogsList === 'function') renderLogsList(logs) } catch(e){}

                function onMoodUpdate(e){
                    const next = (e && e.detail) ? e.detail : safeParse(localStorage.getItem(STORAGE_KEY)) || []
                    setLogs(next)
                    try{ if (typeof renderMoodChart === 'function') renderMoodChart(next) } catch(e){}
                    try{ if (typeof renderLogsList === 'function') renderLogsList(next) } catch(e){}
                }
                window.addEventListener('moodHistoryUpdated', onMoodUpdate)
                window.addEventListener('storage', onMoodUpdate)
                window.addEventListener('restoreConversation', (e)=>{
                    const entry = e && e.detail ? e.detail : null
                    if (entry && entry.conversation) setMessages(entry.conversation)
                })
                return ()=>{
                    window.removeEventListener('moodHistoryUpdated', onMoodUpdate)
                    window.removeEventListener('storage', onMoodUpdate)
                }
            // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [])

            React.useEffect(()=>{ if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight }, [messages, isTyping])

            function pushUser(text){ setMessages(prev=>[...prev,{type:'user', text}]) }
            function pushBot(text, meta){ setMessages(prev=>[...prev,{type:'bot', text, meta}]) }

            const crisisPatterns = ['kill myself','end my life','suicide','hurt myself','cutting','no reason to live','i might harm']
            function detectCrisis(text){ const lt=(text||'').toLowerCase(); return crisisPatterns.some(p => lt.includes(p)) }

            function addLog(mood, note, meta){
                const entry = { date: nowDate(), mood: Number(mood), tags: (meta && meta.tags) || [], notes: note || '' }
                if (meta && meta.conversation) entry.conversation = meta.conversation
                if (meta && meta.starter) entry.starter = meta.starter
                const existing = logs.findIndex(l => l.date === entry.date)
                const next = existing !== -1 ? logs.slice().map((v,i)=> i===existing?entry:v) : [...logs, entry]
                persistLogs(next)
            }

            function handleSendText(raw){
                const text = raw || input
                if (!text || !text.trim()) return
                pushUser(text)
                setInput('')
                setIsTyping(true)
                const moodMatch = (text||'').match(/mood\s*[:\-]?\s*([1-5])(?:\s*[-–—]\s*(.+))?/i)
                if (moodMatch){ addLog(Number(moodMatch[1]), moodMatch[2] ? moodMatch[2].trim() : '', { conversation: messages.slice(), starter: lastStarterRef.current }); setIsTyping(false); pushBot('Saved to Your Logs.'); return }
                setTimeout(()=>{
                    setIsTyping(false)
                    if (detectCrisis(text)){ pushBot("I'm worried by what you shared. If you're in immediate danger, call emergency services."); return }
                    pushBot('Thanks for sharing — can you tell me how long you\'ve felt like this?')
                    lastStarterRef.current = null
                }, 600)
            }

            function handleInlineFormSubmit(e){
                e && e.preventDefault && e.preventDefault()
                const mood = document.querySelector('input[name="mf-mood"]:checked')
                const tags = (document.getElementById('mf-tags') && document.getElementById('mf-tags').value) || ''
                const notes = (document.getElementById('mf-notes') && document.getElementById('mf-notes').value) || ''
                if (!mood){ try{ if (typeof showToast === 'function') showToast('Select a mood before saving', 'warn') } catch(e){}; return }
                addLog(Number(mood.value), notes, { conversation: messages.slice(), starter: currentStarter, tags: tags.split(',').map(t=>t.trim()).filter(Boolean) })
                try{ if (typeof showToast === 'function') showToast('Check-in saved', 'success') } catch(e){}
            }

            function clearLogs(){ if (!confirm('Clear all saved mood logs?')) return; persistLogs([]); pushBot('Your saved mood logs have been cleared.') }
            function resetConversation(){ if (!confirm('Reset conversation?')) return; try { const snapshot = { date: nowDate(), mood: null, notes: '', conversation: messages.slice() }; persistLogs([...logs, snapshot]) } catch (e){}; setMessages([]); pushBot('Conversation reset.') }

            return (
                <div className="mindflow-container">
                    <div style={{ marginBottom: 12 }}>
                        <h3 style={{ margin: 0 }}>Mind Flow</h3>
                        <p className="text-muted">A calm place to share — I'll ask a few gentle questions and help find resources if needed.</p>
                    </div>

                    <div className="card" style={{ padding: 12 }}>
                        <div style={{ marginTop: 4 }}>
                            <div style={{ fontSize: 13, color: '#666', marginBottom: 6 }}>Start quickly</div>
                            <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                                {startOptions.map((opt,i) => (
                                    <button key={i} onClick={() => { lastStarterRef.current = opt.label; setCurrentStarter(opt.label); setInput(opt.text); setTimeout(()=>handleSendText(opt.text), 200) }} className="control-btn">{opt.label}</button>
                                ))}
                            </div>
                        </div>

                        <div style={{ marginTop: 16 }}>
                            <strong style={{ fontSize: 13 }}>Select a mood (optional)</strong>
                            <div className="mf-mood-picker" role="group" aria-label="Select mood" style={{ display:'flex', gap:8, marginTop:8, flexWrap:'wrap' }}>
                                {[5,4,3,2,1].map(v => (
                                    <button type="button" key={v} className={"mood-chip" + (selectedMood===v?" active":"")} onClick={()=>setSelectedMood(v)} aria-pressed={selectedMood===v}>{v}</button>
                                ))}
                                <button type="button" className="mood-chip clear" onClick={()=>setSelectedMood(null)} aria-pressed={selectedMood===null}>Clear</button>
                            </div>
                        </div>

                        <div ref={scrollRef} style={{ maxHeight: 300, overflowY: 'auto', marginTop: 18 }}>
                            {messages.length === 0 && <div style={{ textAlign: 'center', color: '#888', padding: '30px 0' }}>Type a message to begin — I’ll ask a few short questions to help.</div>}
                            {messages.map((m, idx) => (
                                <div key={idx} style={{ marginBottom: 10, textAlign: m.type==='user'?'right':'left' }}>
                                    <div className={"chat-bubble " + (m.type==='user'?'user':'bot')}>{m.text}</div>
                                </div>
                            ))}
                        </div>
                        <div style={{ display: 'flex', flexDirection:'column', gap: 10, marginTop: 12 }}>
                            <div style={{ display:'flex', gap:8 }}>
                                <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter' && handleSendText()} placeholder={selectedMood?`Optional note for mood ${selectedMood}`:'Type your message here...'} />
                                <button onClick={()=>handleSendText()} className="primary-btn">Send</button>
                            </div>
                            <div style={{ display:'flex', gap:8, flexWrap:'wrap' }}>
                                <button type="button" disabled={!selectedMood} className="control-btn" onClick={()=>{ if(!selectedMood) return; addLog(selectedMood, input.trim(), { conversation: messages.slice(), starter: currentStarter, tags: (input.match(/#[\w-]{2,24}/g)||[]).map(t=>t.slice(1)) }); setInput(''); setSelectedMood(null); pushBot('Mood saved.'); }}>Save Mood</button>
                                <button onClick={clearLogs} className="secondary-btn">Clear logs</button>
                                <button onClick={resetConversation} className="control-btn">Reset chat</button>
                            </div>
                        </div>
                    </div>
                </div>
            )
        }

        ReactDOM.createRoot(document.getElementById('mind-flow-root')).render(<MindFlow />)
        </script>
        </div><!-- /legacy-app -->
    </body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Hub page: start everything from here (no auto-redirect) -->
  <title>MindFlow Sanctuary - Mental Health Support</title>
  <style>
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: linear-gradient(180deg, #E9F7FF, #F0E9FF); 
      color: #2d3748; 
      display: grid; 
      place-items: center; 
      height: 100vh; 
      margin: 0; 
    }
    .card { 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(10px);
      padding: 32px 40px; 
      border-radius: 16px; 
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.08); 
      text-align: center; 
      max-width: 400px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .logo { font-size: 1.8em; font-weight: 700; color: #2d3748; margin-bottom: 12px; }
    .tagline { color: #4a5568; margin-bottom: 20px; font-size: 0.95em; line-height: 1.5; }
  .loading { display: flex; align-items: center; justify-content: center; gap: 8px; color: #48bb78; }
    .spinner { width: 16px; height: 16px; border: 2px solid #e2e8f0; border-top: 2px solid #48bb78; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    a { color: #48bb78; text-decoration: none; font-weight: 500; }
    a:hover { text-decoration: underline; }
    .emergency { font-size: 0.8em; color: #64748b; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0; }
    .actions { display: grid; gap: 10px; margin-top: 14px; }
    .btn { display: inline-block; padding: 10px 14px; border-radius: 10px; font-weight: 600; }
    .btn.primary { background: #48bb78; color: #fff; }
    .btn.secondary { background: #667eea; color: #fff; }
    .btn.muted { background: #edf2f7; color: #2d3748; }
    .note { font-size: 0.85em; color: #64748b; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">ðŸŒ± MindFlow Sanctuary</div>
    <div class="tagline">Your secure, confidential space for mental wellness</div>
    <div class="actions">
      <button 
        id="enter-sanctuary-btn" 
        class="btn primary enter-sanctuary-button" 
        onclick="handleEnterSanctuary(event)"
        onkeydown="handleEnterSanctuaryKeyboard(event)"
        type="button"
        aria-label="Enter MindFlow Sanctuary - Start your confidential mental health support session"
        title="Click to access your secure, private mental health support space"
      >
        <span class="btn-icon" aria-hidden="true">ðŸŒ±</span>
        <span class="btn-text">Enter Sanctuary</span>
        <span class="btn-status" id="btn-status" aria-live="polite"></span>
      </button>
      <a class="btn secondary" href="resources.html">Browse Resources</a>
    </div>
    <div class="note" id="server-note">Checking server statusâ€¦</div>
    <div class="emergency">
      <strong>Crisis support:</strong> Call 988 or 911 for immediate help
    </div>
  </div>
  <!-- Enhanced button styling -->
  <style>
    .enter-sanctuary-button {
      position: relative;
      display: flex !important;
      align-items: center;
      gap: 8px;
      min-height: 48px;
      transition: all 0.3s ease;
      cursor: pointer;
      overflow: hidden;
    }
    
    .enter-sanctuary-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(72, 187, 120, 0.3);
    }
    
    .enter-sanctuary-button:active {
      transform: translateY(0);
    }
    
    .enter-sanctuary-button:focus {
      outline: 3px solid rgba(72, 187, 120, 0.5);
      outline-offset: 2px;
    }
    
    .enter-sanctuary-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-icon {
      font-size: 1.2em;
      animation: gentle-pulse 2s infinite;
    }
    
    .btn-text {
      font-weight: 600;
      font-size: 1.1em;
    }
    
    .btn-status {
      font-size: 0.8em;
      margin-left: auto;
      opacity: 0.8;
    }
    
    @keyframes gentle-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Success state */
    .enter-sanctuary-button.success {
      background: #10b981 !important;
    }
    
    /* Error state */
    .enter-sanctuary-button.error {
      background: #ef4444 !important;
      animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
  </style>

  <!-- Load main JavaScript first -->
  <script src="js/main.js"></script>
  
  <script>
    // Enter Sanctuary button handler
    let isProcessing = false;
    
    function updateButtonStatus(message, type = 'info') {
      const statusEl = document.getElementById('btn-status');
      const button = document.getElementById('enter-sanctuary-btn');
      
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.className = `btn-status ${type}`;
      }
      
      if (button) {
        button.className = `btn primary enter-sanctuary-button ${type}`;
        if (type === 'loading') {
          button.innerHTML = `
            <span class="btn-icon" aria-hidden="true">ðŸŒ±</span>
            <span class="btn-text">Entering...</span>
            <div class="loading-spinner" aria-hidden="true"></div>
          `;
        }
      }
    }
    
    function resetButton() {
      const button = document.getElementById('enter-sanctuary-btn');
      if (button) {
        button.disabled = false;
        button.innerHTML = `
          <span class="btn-icon" aria-hidden="true">ðŸŒ±</span>
          <span class="btn-text">Enter Sanctuary</span>
          <span class="btn-status" id="btn-status" aria-live="polite"></span>
        `;
        button.className = 'btn primary enter-sanctuary-button';
      }
      isProcessing = false;
    }
    
    async function handleEnterSanctuary(event) {
      if (isProcessing) {
        return;
      }
      
      isProcessing = true;
      
      const button = document.getElementById('enter-sanctuary-btn');
      if (button) {
        button.disabled = true;
      }
      
      updateButtonStatus('Preparing...', 'loading');
      
      try {
        // Try direct function call
        if (typeof window.enterNow === 'function') {
          updateButtonStatus('Loading sanctuary...', 'loading');
          await new Promise(resolve => setTimeout(resolve, 500));
          window.enterNow();
          updateButtonStatus('Success!', 'success');
          return;
        }
        
        // Try enterSanctuaryWithDB
        if (typeof window.enterSanctuaryWithDB === 'function') {
          updateButtonStatus('Connecting to database...', 'loading');
          await new Promise(resolve => setTimeout(resolve, 500));
          await window.enterSanctuaryWithDB();
          updateButtonStatus('Success!', 'success');
          return;
        }
        
        // Try enterSanctuary
        if (typeof window.enterSanctuary === 'function') {
          updateButtonStatus('Entering sanctuary...', 'loading');
          await new Promise(resolve => setTimeout(resolve, 500));
          window.enterSanctuary();
          updateButtonStatus('Success!', 'success');
          return;
        }
        
        // Try MindFlowCore
        if (window.MindFlowCore && typeof window.MindFlowCore.enterNow === 'function') {
          updateButtonStatus('Starting MindFlow...', 'loading');
          await new Promise(resolve => setTimeout(resolve, 500));
          window.MindFlowCore.enterNow();
          updateButtonStatus('Success!', 'success');
          return;
        }
        
        // Direct navigation with enhanced experience
        updateButtonStatus('Navigating to sanctuary...', 'loading');
        
        // Store entry context
        sessionStorage.setItem('mindflow_entry_time', Date.now().toString());
        sessionStorage.setItem('mindflow_entry_method', 'index_button');
        
        // Add visual feedback before navigation
        await new Promise(resolve => setTimeout(resolve, 800));
        
        // Navigate with enhanced URL parameters
        const targetUrl = new URL('unified-sanctuary.html', window.location.href);
        targetUrl.searchParams.set('entry', 'button');
        targetUrl.searchParams.set('timestamp', Date.now().toString());
        
        updateButtonStatus('Redirecting...', 'success');
        
        // Use replace to avoid back button issues
        window.location.replace(targetUrl.toString());
        
      } catch (error) {
        updateButtonStatus('Error - Retrying...', 'error');
        
        // Fallback: Simple redirect
        setTimeout(() => {
          window.location.href = 'unified-sanctuary.html';
        }, 1500);
      }
      
      // Reset button after delay if still on page
      setTimeout(() => {
        if (document.getElementById('enter-sanctuary-btn')) {
          resetButton();
        }
      }, 5000);
    }
    
    function handleEnterSanctuaryKeyboard(event) {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        handleEnterSanctuary(event);
      }
    }
    
    // Light server availability check (optional) to hint about live metrics
    (async function(){
      const note = document.getElementById('server-note');
      if (!note) return;
      
      try {
        // Add timeout to prevent hanging
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const r = await fetch('/healthz', {
          cache: 'no-store',
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (r.ok) {
          const data = await r.json();
          note.textContent = 'Server online â€” live metrics and database features are enabled.';
          note.style.color = '#2f855a';
          if (window.mindflowState) window.mindflowState.isConnected = true;
        } else {
          throw new Error(`Server responded with ${r.status}`);
        }
      } catch(e) {
        console.log('Server check failed:', e.message);
        note.textContent = 'Server offline â€” you can still explore the app, but live data will be static. Start it with: node server.js';
        note.style.color = '#b7791f';
        if (window.mindflowState) window.mindflowState.isConnected = false;
      }
    })();
    
    // Initialize button when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('DOM loaded, initializing button');
      
      const button = document.getElementById('enter-sanctuary-btn');
      if (button) {
        debugLog('Button found, adding event listeners');
        
        // Double-check event listeners are attached
        button.removeEventListener('click', handleEnterSanctuary); // Remove any duplicates
        button.addEventListener('click', handleEnterSanctuary);
        
        // Add additional safety listeners
        button.addEventListener('touchend', function(e) {
          e.preventDefault();
          handleEnterSanctuary(e);
        });
        
        // Visual feedback on interaction
        button.addEventListener('mousedown', function() {
          this.style.transform = 'translateY(1px)';
        });
        
        button.addEventListener('mouseup', function() {
          this.style.transform = 'translateY(-2px)';
        });
        
        button.addEventListener('mouseleave', function() {
          this.style.transform = '';
        });
        
        debugLog('Button initialization complete');
        updateButtonStatus('Ready', 'info');
      } else {
        debugLog('ERROR: Button not found!');
      }
    });
    
    // Global function for external calls
    window.triggerEnterSanctuary = handleEnterSanctuary;
    
    debugLog('Enter Sanctuary button system loaded');
  </script>
</body>
</html>